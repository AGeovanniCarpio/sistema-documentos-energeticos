<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Automatizado de Informes - Firebase + DOCX + PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librer√≠as para DOCX y PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.40.5/docxtemplater.js"></script>
    <!-- Librer√≠a para manejo de im√°genes en DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater-image-module/3.1.1/docxtemplater-image-module.js"></script>
</head>
<body class="bg-gray-50">
    
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-700 to-indigo-800 text-white p-8 rounded-xl mb-8 shadow-lg">
            <h1 class="text-3xl font-bold mb-2">üè¢ Sistema Automatizado de Informes T√©cnicos</h1>
            <p class="text-blue-100 mb-4">Generaci√≥n autom√°tica de auditor√≠as energ√©ticas desde Firebase</p>
            <div class="flex items-center space-x-6 text-sm">
                <div>Estado Firebase: <span id="firebaseStatus" class="font-semibold">üîÑ Conectando...</span></div>
                <div>Plantillas: <span id="plantillasCount" class="font-semibold">0</span></div>
                <div>Datos disponibles: <span id="datosCount" class="font-semibold">0</span></div>
            </div>
        </div>

        <!-- Panel de Estado -->
        <div id="statusPanel" class="mb-6"></div>

        <div class="grid lg:grid-cols-4 gap-6">
            
            <!-- Panel 1: Subida de Plantillas DOCX -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    üì§ Subir Plantilla DOCX
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre de la plantilla</label>
                        <input type="text" id="nombrePlantilla" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Auditor√≠a Energ√©tica 2025">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Archivo DOCX</label>
                        <input type="file" id="archivoPlantilla" accept=".docx" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Solo archivos .docx con placeholders como {{cliente}}, {{consumo}}, etc.</p>
                    </div>
                    
                    <button onclick="subirPlantilla()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        üì§ Subir a Firebase
                    </button>
                </div>
                
                <!-- Lista de Plantillas -->
                <div class="mt-6 border-t pt-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Plantillas Disponibles</h3>
                    <div id="listaPlantillas" class="space-y-2">
                        <p class="text-sm text-gray-500">Cargando...</p>
                    </div>
                </div>
            </div>
            
            <!-- Panel 2: Subida de Im√°genes -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    üñºÔ∏è Gesti√≥n de Im√°genes
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre de la imagen</label>
                        <input type="text" id="nombreImagen" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="logo_empresa">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Archivo de imagen</label>
                        <input type="file" id="archivoImagen" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF. Se usar√° como {{imagen_nombre}}</p>
                    </div>
                    
                    <button onclick="subirImagen()" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        üñºÔ∏è Subir Imagen
                    </button>
                </div>
                
                <!-- Galer√≠a de Im√°genes -->
                <div class="mt-6 border-t pt-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Im√°genes Disponibles</h3>
                    <div id="galeriaImagenes" class="grid grid-cols-2 gap-2">
                        <p class="text-sm text-gray-500 col-span-2">Cargando...</p>
                    </div>
                </div>
            </div>
            
            <!-- Panel 3: Datos del Sistema -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    üìä Datos del Sistema
                </h2>
                
                <!-- Datos de Climatolog√≠a -->
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-700 mb-2">M√≥dulo Climatolog√≠a</h3>
                    <div id="datosClimatologia" class="bg-gray-50 p-3 rounded text-sm">
                        <p class="text-gray-500">Cargando datos...</p>
                    </div>
                </div>
                
                <!-- Datos de Calculadoras -->
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Calculadoras</h3>
                    <div id="datosCalculadoras" class="bg-gray-50 p-3 rounded text-sm">
                        <p class="text-gray-500">Cargando datos...</p>
                    </div>
                </div>
                
                <!-- Datos de Facturaci√≥n -->
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Facturaci√≥n</h3>
                    <div id="datosFacturacion" class="bg-gray-50 p-3 rounded text-sm">
                        <p class="text-gray-500">Cargando datos...</p>
                    </div>
                </div>
                
                <!-- Datos Solares -->
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">M√≥dulo Solar</h3>
                    <div id="datosSolar" class="bg-gray-50 p-3 rounded text-sm">
                        <p class="text-gray-500">Cargando datos...</p>
                    </div>
                </div>
                
                <button onclick="actualizarDatos()" class="w-full mt-4 bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                    üîÑ Actualizar Datos
                </button>
            </div>
            
            <!-- Panel 4: Generaci√≥n de Informes -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    üìÑ Generar Informe
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Seleccionar Plantilla</label>
                        <select id="plantillaSeleccionada" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccione una plantilla...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Cliente/Proyecto</label>
                        <input type="text" id="nombreCliente" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Industrias Ejemplo S.A." value="Industrias Ejemplo S.A.">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha del informe</label>
                        <input type="date" id="fechaInforme" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="generarDOCX()" id="btnGenerarDOCX" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" disabled>
                            üìò DOCX
                        </button>
                        <button onclick="generarPDF()" id="btnGenerarPDF" class="bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition-colors" disabled>
                            üìÑ PDF
                        </button>
                    </div>
                    
                    <button onclick="previsualizarInforme()" id="btnPrevisualizar" class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors" disabled>
                        üëÅÔ∏è Previsualizar Informe
                    </button>
                </div>
                
                <!-- Variables Disponibles -->
                <div class="mt-6 border-t pt-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Variables Disponibles</h3>
                    <div id="variablesDisponibles" class="text-xs text-gray-600 space-y-1">
                        <p>{{cliente}} - Nombre del cliente</p>
                        <p>{{fecha}} - Fecha del informe</p>
                        <p>{{temperatura_promedio}} - Datos climatolog√≠a</p>
                        <p>{{consumo_electrico}} - Datos calculadoras</p>
                        <p>{{costo_energia}} - Datos facturaci√≥n</p>
                        <p>{{radiacion_solar}} - Datos solares</p>
                        <p>{{imagen_logo}} - Im√°genes subidas</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Historial de Informes Generados -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">üìö Historial de Informes</h2>
                <button onclick="cargarHistorial()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    üîÑ Actualizar
                </button>
            </div>
            <div id="historialInformes">
                <p class="text-gray-500 text-center py-8">Cargando historial...</p>
            </div>
        </div>
    </div>

    <!-- Modal de Previsualizaci√≥n -->
    <div id="modalPreview" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl max-w-5xl w-full m-4 max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold">üëÅÔ∏è Previsualizaci√≥n del Informe</h3>
                <button onclick="cerrarPreview()" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div id="contenidoPreview" class="prose max-w-none"></div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button onclick="cerrarPreview()" class="bg-gray-500 text-white px-6 py-2 rounded-lg">Cerrar</button>
                <button onclick="generarDesdePrevisualizacion()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Generar DOCX</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, setDoc, doc, query, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD2lCwOZAFFrFN8pXf-OCye204D7awyl_Q",
            authDomain: "modulodatoswordautomatico.firebaseapp.com",
            projectId: "modulodatoswordautomatico",
            storageBucket: "modulodatoswordautomatico.appspot.com",
            messagingSenderId: "744851515219",
            appId: "1:744851515219:web:5ece87673cc094f116a3a6"
        };

        // Variables globales
        let app, db, auth, storage;
        let isFirebaseConnected = false;
        let plantillasDisponibles = {};
        let imagenesDisponibles = {};
        let datosDelSistema = {};
        let plantillaActual = null;

        // Inicializar Firebase y sistema
        async function inicializarSistema() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                await signInAnonymously(auth);
                isFirebaseConnected = true;
                
                document.getElementById('firebaseStatus').innerHTML = 'üî• Conectado';
                document.getElementById('firebaseStatus').className = 'font-semibold text-green-300';
                
                await Promise.all([
                    cargarPlantillas(),
                    cargarImagenes(),
                    cargarDatosDelSistema(),
                    cargarHistorial()
                ]);
                
                mostrarStatus('‚úÖ Sistema inicializado correctamente', 'success');
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                document.getElementById('firebaseStatus').innerHTML = '‚ö†Ô∏è Offline';
                mostrarStatus('‚ùå Error conectando con Firebase: ' + error.message, 'error');
            }
        }

        // Cargar plantillas DOCX desde Firebase
        async function cargarPlantillas() {
            try {
                const snapshot = await getDocs(collection(db, 'plantillas_docx'));
                plantillasDisponibles = {};
                
                const listElement = document.getElementById('listaPlantillas');
                const selectElement = document.getElementById('plantillaSeleccionada');
                
                listElement.innerHTML = '';
                selectElement.innerHTML = '<option value="">Seleccione una plantilla...</option>';
                
                if (snapshot.empty) {
                    listElement.innerHTML = '<p class="text-sm text-gray-500">No hay plantillas subidas</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const plantilla = { id: doc.id, ...doc.data() };
                    plantillasDisponibles[doc.id] = plantilla;
                    
                    // Lista visual
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 p-2 rounded text-sm flex justify-between items-center';
                    div.innerHTML = `
                        <span class="font-medium">${plantilla.nombre}</span>
                        <button onclick="eliminarPlantilla('${doc.id}')" class="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è</button>
                    `;
                    listElement.appendChild(div);
                    
                    // Selector
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = plantilla.nombre;
                    selectElement.appendChild(option);
                });
                
                document.getElementById('plantillasCount').textContent = snapshot.size;
                habilitarBotones();
                
            } catch (error) {
                console.error('Error cargando plantillas:', error);
                mostrarStatus('‚ùå Error cargando plantillas: ' + error.message, 'error');
            }
        }

        // Cargar im√°genes desde Firebase Storage
        async function cargarImagenes() {
            try {
                const imagenesRef = ref(storage, 'imagenes_informes/');
                const result = await listAll(imagenesRef);
                
                imagenesDisponibles = {};
                const galeriaElement = document.getElementById('galeriaImagenes');
                galeriaElement.innerHTML = '';
                
                if (result.items.length === 0) {
                    galeriaElement.innerHTML = '<p class="text-sm text-gray-500 col-span-2">No hay im√°genes subidas</p>';
                    return;
                }
                
                for (const itemRef of result.items) {
                    try {
                        const url = await getDownloadURL(itemRef);
                        const nombre = itemRef.name.split('.')[0];
                        
                        imagenesDisponibles[nombre] = {
                            nombre: nombre,
                            url: url,
                            ref: itemRef
                        };
                        
                        const div = document.createElement('div');
                        div.className = 'relative group';
                        div.innerHTML = `
                            <img src="${url}" alt="${nombre}" class="w-full h-16 object-cover rounded border">
                            <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <button onclick="eliminarImagen('${nombre}')" class="text-white text-xs">üóëÔ∏è</button>
                            </div>
                            <p class="text-xs text-center mt-1 truncate">${nombre}</p>
                        `;
                        galeriaElement.appendChild(div);
                        
                    } catch (error) {
                        console.error('Error cargando imagen:', itemRef.name, error);
                    }
                }
                
            } catch (error) {
                console.error('Error cargando im√°genes:', error);
                mostrarStatus('‚ùå Error cargando im√°genes: ' + error.message, 'error');
            }
        }

        // Cargar datos de todos los m√≥dulos del sistema
        async function cargarDatosDelSistema() {
            try {
                datosDelSistema = {};
                
                // Cargar datos de climatolog√≠a
                const climatologiaSnapshot = await getDocs(query(collection(db, 'climatologia'), orderBy('fecha', 'desc'), limit(1)));
                if (!climatologiaSnapshot.empty) {
                    datosDelSistema.climatologia = climatologiaSnapshot.docs[0].data();
                    document.getElementById('datosClimatologia').innerHTML = `
                        <p><strong>Temperatura:</strong> ${datosDelSistema.climatologia.temperatura || 'N/A'}¬∞C</p>
                        <p><strong>Humedad:</strong> ${datosDelSistema.climatologia.humedad || 'N/A'}%</p>
                        <p><strong>√öltima actualizaci√≥n:</strong> ${new Date(datosDelSistema.climatologia.fecha).toLocaleDateString('es-ES')}</p>
                    `;
                }
                
                // Cargar datos de calculadoras
                const calculadorasSnapshot = await getDocs(query(collection(db, 'calculadoras'), orderBy('created_at', 'desc'), limit(1)));
                if (!calculadorasSnapshot.empty) {
                    datosDelSistema.calculadoras = calculadorasSnapshot.docs[0].data();
                    document.getElementById('datosCalculadoras').innerHTML = `
                        <p><strong>Consumo:</strong> ${datosDelSistema.calculadoras.consumo_kwh || 'N/A'} kWh</p>
                        <p><strong>Demanda:</strong> ${datosDelSistema.calculadoras.demanda_kw || 'N/A'} kW</p>
                        <p><strong>Ahorro LED:</strong> $${(datosDelSistema.calculadoras.ahorro_led || 0).toLocaleString()}</p>
                    `;
                }
                
                // Cargar datos de facturaci√≥n
                const facturacionSnapshot = await getDocs(query(collection(db, 'facturacion'), orderBy('fecha', 'desc'), limit(1)));
                if (!facturacionSnapshot.empty) {
                    datosDelSistema.facturacion = facturacionSnapshot.docs[0].data();
                    document.getElementById('datosFacturacion').innerHTML = `
                        <p><strong>Costo mensual:</strong> $${(datosDelSistema.facturacion.costo_mensual || 0).toLocaleString()}</p>
                        <p><strong>Costo anual:</strong> $${(datosDelSistema.facturacion.costo_anual || 0).toLocaleString()}</p>
                        <p><strong>Tarifa:</strong> ${datosDelSistema.facturacion.tarifa || 'N/A'}</p>
                    `;
                }
                
                // Cargar datos solares
                const solarSnapshot = await getDocs(query(collection(db, 'solar'), orderBy('fecha', 'desc'), limit(1)));
                if (!solarSnapshot.empty) {
                    datosDelSistema.solar = solarSnapshot.docs[0].data();
                    document.getElementById('datosSolar').innerHTML = `
                        <p><strong>Radiaci√≥n:</strong> ${datosDelSistema.solar.radiacion || 'N/A'} kWh/m¬≤</p>
                        <p><strong>Potencia recomendada:</strong> ${datosDelSistema.solar.potencia_kw || 'N/A'} kW</p>
                        <p><strong>Ahorro estimado:</strong> $${(datosDelSistema.solar.ahorro_anual || 0).toLocaleString()}</p>
                    `;
                }
                
                const totalDatos = Object.keys(datosDelSistema).length;
                document.getElementById('datosCount').textContent = totalDatos;
                
            } catch (error) {
                console.error('Error cargando datos del sistema:', error);
                mostrarStatus('‚ùå Error cargando datos: ' + error.message, 'error');
            }
        }

        // Subir plantilla DOCX a Firebase
        async function subirPlantilla() {
            const nombre = document.getElementById('nombrePlantilla').value.trim();
            const archivo = document.getElementById('archivoPlantilla').files[0];
            
            if (!nombre || !archivo) {
                mostrarStatus('‚ùå Complete el nombre y seleccione un archivo DOCX', 'error');
                return;
            }
            
            if (!archivo.name.toLowerCase().endsWith('.docx')) {
                mostrarStatus('‚ùå Solo se permiten archivos .docx', 'error');
                return;
            }
            
            try {
                mostrarStatus('üîÑ Subiendo plantilla...', 'info');
                
                // Subir archivo a Storage
                const storageRef = ref(storage, `plantillas_docx/${Date.now()}_${archivo.name}`);
                const snapshot = await uploadBytes(storageRef, archivo);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                // Guardar metadata en Firestore
                const plantillaData = {
                    nombre: nombre,
                    archivo_url: downloadURL,
                    archivo_nombre: archivo.name,
                    tama√±o: archivo.size,
                    subido_en: new Date().toISOString(),
                    tipo: 'docx'
                };
                
                await addDoc(collection(db, 'plantillas_docx'), plantillaData);
                
                // Limpiar formulario
                document.getElementById('nombrePlantilla').value = '';
                document.getElementById('archivoPlantilla').value = '';
                
                await cargarPlantillas();
                mostrarStatus(`‚úÖ Plantilla "${nombre}" subida exitosamente`, 'success');
                
            } catch (error) {
                console.error('Error subiendo plantilla:', error);
                mostrarStatus('‚ùå Error subiendo plantilla: ' + error.message, 'error');
            }
        }

        // Subir imagen a Firebase Storage
        async function subirImagen() {
            const nombre = document.getElementById('nombreImagen').value.trim();
            const archivo = document.getElementById('archivoImagen').files[0];
            
            if (!nombre || !archivo) {
                mostrarStatus('‚ùå Complete el nombre y seleccione una imagen', 'error');
                return;
            }
            
            if (!archivo.type.startsWith('image/')) {
                mostrarStatus('‚ùå Solo se permiten archivos de imagen', 'error');
                return;
            }
            
            try {
                mostrarStatus('üîÑ Subiendo imagen...', 'info');
                
                const extension = archivo.name.split('.').pop();
                const nombreArchivo = `${nombre}.${extension}`;
                const storageRef = ref(storage, `imagenes_informes/${nombreArchivo}`);
                
                await uploadBytes(storageRef, archivo);
                
                // Limpiar formulario
                document.getElementById('nombreImagen').value = '';
                document.getElementById('archivoImagen').value = '';
                
                await cargarImagenes();
                mostrarStatus(`‚úÖ Imagen "${nombre}" subida exitosamente`, 'success');
                
            } catch (error) {
                console.error('Error subiendo imagen:', error);
                mostrarStatus('‚ùå Error subiendo imagen: ' + error.message, 'error');
            }
        }

        // Generar documento DOCX con datos de Firebase
        async function generarDOCX() {
            const plantillaId = document.getElementById('plantillaSeleccionada').value;
            const cliente = document.getElementById('nombreCliente').value.trim();
            const fecha = document.getElementById('fechaInforme').value;
            
            if (!plantillaId) {
                mostrarStatus('‚ùå Seleccione una plantilla', 'error');
                return;
            }
            
            if (!cliente) {
                mostrarStatus('‚ùå Ingrese el nombre del cliente', 'error');
                return;
            }
            
            try {
                mostrarStatus('üîÑ Generando documento DOCX...', 'info');
                
                const plantilla = plantillasDisponibles[plantillaId];
                
                // Descargar plantilla DOCX
                const response = await fetch(plantilla.archivo_url);
                const arrayBuffer = await response.arrayBuffer();
                
                // Preparar datos para reemplazar
                const datosParaReemplazar = prepararDatosParaPlantilla(cliente, fecha);
                
                // Procesar plantilla con docxtemplater
                const zip = new PizZip(arrayBuffer);
                const doc = new Docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });
                
                // Reemplazar variables
                doc.setData(datosParaReemplazar);
                
                try {
                    doc.render();
                } catch (error) {
                    console.error('Error rendering template:', error);
                    mostrarStatus('‚ùå Error procesando plantilla: ' + error.message, 'error');
                    return;
                }
                
                // Generar archivo final
                const buffer = doc.getZip().generate({ type: 'blob' });
                
                // Guardar registro en Firebase
                await guardarRegistroInforme(plantillaId, cliente, fecha, 'docx');
                
                // Descargar archivo
                const nombreArchivo = `Informe_${cliente.replace(/\s+/g, '_')}_${fecha || new Date().toISOString().split('T')[0]}.docx`;
                descargarArchivo(buffer, nombreArchivo);
                
                mostrarStatus(`‚úÖ Documento DOCX generado: ${nombreArchivo}`, 'success');
                await cargarHistorial();
                
            } catch (error) {
                console.error('Error generando DOCX:', error);
                mostrarStatus('‚ùå Error generando DOCX: ' + error.message, 'error');
            }
        }

        // Generar PDF desde los datos
        async function generarPDF() {
            const plantillaId = document.getElementById('plantillaSeleccionada').value;
            const cliente = document.getElementById('nombreCliente').value.trim();
            const fecha = document.getElementById('fechaInforme').value;
            
            if (!plantillaId) {
                mostrarStatus('‚ùå Seleccione una plantilla', 'error');
                return;
            }
            
            if (!cliente) {
                mostrarStatus('‚ùå Ingrese el nombre del cliente', 'error');
                return;
            }
            
            try {
                mostrarStatus('üîÑ Generando documento PDF...', 'info');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const datosParaReemplazar = prepararDatosParaPlantilla(cliente, fecha);
                
                // Configurar PDF
                doc.setFont('helvetica');
                
                // T√≠tulo
                doc.setFontSize(20);
                doc.setTextColor(44, 90, 160);
                doc.text('INFORME T√âCNICO DE AUDITOR√çA ENERG√âTICA', 20, 30);
                
                // Informaci√≥n del cliente
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                let y = 50;
                
                doc.text(`Cliente: ${cliente}`, 20, y);
                y += 10;
                doc.text(`Fecha: ${fecha || new Date().toLocaleDateString('es-ES')}`, 20, y);
                y += 20;
                
                // Datos de climatolog√≠a
                if (datosDelSistema.climatologia) {
                    doc.setFontSize(16);
                    doc.setTextColor(44, 90, 160);
                    doc.text('DATOS CLIMATOL√ìGICOS', 20, y);
                    y += 10;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Temperatura promedio: ${datosDelSistema.climatologia.temperatura || 'N/A'}¬∞C`, 20, y);
                    y += 7;
                    doc.text(`Humedad relativa: ${datosDelSistema.climatologia.humedad || 'N/A'}%`, 20, y);
                    y += 15;
                }
                
                // Datos de consumo energ√©tico
                if (datosDelSistema.calculadoras) {
                    doc.setFontSize(16);
                    doc.setTextColor(44, 90, 160);
                    doc.text('AN√ÅLISIS ENERG√âTICO', 20, y);
                    y += 10;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Consumo anual: ${(datosDelSistema.calculadoras.consumo_kwh || 0).toLocaleString()} kWh`, 20, y);
                    y += 7;
                    doc.text(`Demanda m√°xima: ${datosDelSistema.calculadoras.demanda_kw || 0} kW`, 20, y);
                    y += 7;
                    doc.text(`Ahorro estimado LED: ${(datosDelSistema.calculadoras.ahorro_led || 0).toLocaleString()}`, 20, y);
                    y += 15;
                }
                
                // Datos de facturaci√≥n
                if (datosDelSistema.facturacion) {
                    doc.setFontSize(16);
                    doc.setTextColor(44, 90, 160);
                    doc.text('AN√ÅLISIS ECON√ìMICO', 20, y);
                    y += 10;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Costo mensual: ${(datosDelSistema.facturacion.costo_mensual || 0).toLocaleString()}`, 20, y);
                    y += 7;
                    doc.text(`Costo anual: ${(datosDelSistema.facturacion.costo_anual || 0).toLocaleString()}`, 20, y);
                    y += 7;
                    doc.text(`Tarifa aplicada: ${datosDelSistema.facturacion.tarifa || 'N/A'}`, 20, y);
                    y += 15;
                }
                
                // Datos solares
                if (datosDelSistema.solar) {
                    doc.setFontSize(16);
                    doc.setTextColor(44, 90, 160);
                    doc.text('POTENCIAL SOLAR', 20, y);
                    y += 10;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Radiaci√≥n solar: ${datosDelSistema.solar.radiacion || 'N/A'} kWh/m¬≤`, 20, y);
                    y += 7;
                    doc.text(`Potencia recomendada: ${datosDelSistema.solar.potencia_kw || 'N/A'} kW`, 20, y);
                    y += 7;
                    doc.text(`Ahorro solar estimado: ${(datosDelSistema.solar.ahorro_anual || 0).toLocaleString()}`, 20, y);
                    y += 15;
                }
                
                // Footer
                doc.setFontSize(10);
                doc.setTextColor(128, 128, 128);
                doc.text('Documento generado autom√°ticamente por el Sistema de Informes T√©cnicos', 20, 280);
                doc.text(`Generado el: ${new Date().toLocaleString('es-ES')}`, 20, 290);
                
                // Guardar registro
                await guardarRegistroInforme(plantillaId, cliente, fecha, 'pdf');
                
                // Descargar
                const nombreArchivo = `Informe_${cliente.replace(/\s+/g, '_')}_${fecha || new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nombreArchivo);
                
                mostrarStatus(`‚úÖ Documento PDF generado: ${nombreArchivo}`, 'success');
                await cargarHistorial();
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                mostrarStatus('‚ùå Error generando PDF: ' + error.message, 'error');
            }
        }

        // Preparar datos para reemplazar en plantilla
        function prepararDatosParaPlantilla(cliente, fecha) {
            const fechaFormateada = fecha || new Date().toLocaleDateString('es-ES');
            
            return {
                // Datos b√°sicos
                cliente: cliente,
                fecha: fechaFormateada,
                fecha_generacion: new Date().toLocaleDateString('es-ES'),
                hora_generacion: new Date().toLocaleTimeString('es-ES'),
                
                // Datos de climatolog√≠a
                temperatura_promedio: datosDelSistema.climatologia?.temperatura || 'N/A',
                humedad_relativa: datosDelSistema.climatologia?.humedad || 'N/A',
                presion_atmosferica: datosDelSistema.climatologia?.presion || 'N/A',
                
                // Datos de calculadoras/consumo
                consumo_electrico: (datosDelSistema.calculadoras?.consumo_kwh || 0).toLocaleString(),
                demanda_maxima: datosDelSistema.calculadoras?.demanda_kw || 0,
                factor_potencia: datosDelSistema.calculadoras?.factor_potencia || 'N/A',
                ahorro_led: formatearMoneda(datosDelSistema.calculadoras?.ahorro_led || 0),
                
                // Datos de facturaci√≥n
                costo_energia_mensual: formatearMoneda(datosDelSistema.facturacion?.costo_mensual || 0),
                costo_energia_anual: formatearMoneda(datosDelSistema.facturacion?.costo_anual || 0),
                tarifa_electrica: datosDelSistema.facturacion?.tarifa || 'N/A',
                
                // Datos solares
                radiacion_solar: datosDelSistema.solar?.radiacion || 'N/A',
                potencia_solar_recomendada: datosDelSistema.solar?.potencia_kw || 'N/A',
                ahorro_solar_estimado: formatearMoneda(datosDelSistema.solar?.ahorro_anual || 0),
                
                // Im√°genes (URLs para insertar)
                ...Object.fromEntries(
                    Object.entries(imagenesDisponibles).map(([nombre, datos]) => [
                        `imagen_${nombre}`, datos.url
                    ])
                ),
                
                // N√∫mero de documento
                numero_documento: `INF-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`
            };
        }

        // Previsualizar informe antes de generar
        async function previsualizarInforme() {
            const plantillaId = document.getElementById('plantillaSeleccionada').value;
            const cliente = document.getElementById('nombreCliente').value.trim();
            const fecha = document.getElementById('fechaInforme').value;
            
            if (!plantillaId) {
                mostrarStatus('‚ùå Seleccione una plantilla', 'error');
                return;
            }
            
            if (!cliente) {
                mostrarStatus('‚ùå Ingrese el nombre del cliente', 'error');
                return;
            }
            
            const datosParaReemplazar = prepararDatosParaPlantilla(cliente, fecha);
            const plantilla = plantillasDisponibles[plantillaId];
            
            // Crear vista previa HTML
            let contenidoHTML = `
                <div class="max-w-4xl mx-auto bg-white p-8 shadow-lg">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-blue-800 mb-2">INFORME T√âCNICO DE AUDITOR√çA ENERG√âTICA</h1>
                        <p class="text-gray-600">Generado autom√°ticamente desde datos de Firebase</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-2">Informaci√≥n del Cliente</h3>
                            <p><strong>Cliente:</strong> ${datosParaReemplazar.cliente}</p>
                            <p><strong>Fecha:</strong> ${datosParaReemplazar.fecha}</p>
                            <p><strong>Documento:</strong> ${datosParaReemplazar.numero_documento}</p>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-2">Plantilla Utilizada</h3>
                            <p><strong>Nombre:</strong> ${plantilla.nombre}</p>
                            <p><strong>Tipo:</strong> ${plantilla.tipo}</p>
                        </div>
                    </div>
            `;
            
            // Datos de climatolog√≠a
            if (datosDelSistema.climatologia) {
                contenidoHTML += `
                    <div class="mb-6">
                        <h3 class="font-bold text-lg text-blue-800 mb-3">üìä Datos Climatol√≥gicos</h3>
                        <div class="bg-blue-50 p-4 rounded-lg grid grid-cols-3 gap-4">
                            <div><strong>Temperatura:</strong> ${datosParaReemplazar.temperatura_promedio}¬∞C</div>
                            <div><strong>Humedad:</strong> ${datosParaReemplazar.humedad_relativa}%</div>
                            <div><strong>Presi√≥n:</strong> ${datosParaReemplazar.presion_atmosferica}</div>
                        </div>
                    </div>
                `;
            }
            
            // Datos energ√©ticos
            if (datosDelSistema.calculadoras) {
                contenidoHTML += `
                    <div class="mb-6">
                        <h3 class="font-bold text-lg text-green-800 mb-3">‚ö° An√°lisis Energ√©tico</h3>
                        <div class="bg-green-50 p-4 rounded-lg grid grid-cols-2 gap-4">
                            <div><strong>Consumo anual:</strong> ${datosParaReemplazar.consumo_electrico} kWh</div>
                            <div><strong>Demanda m√°xima:</strong> ${datosParaReemplazar.demanda_maxima} kW</div>
                            <div><strong>Factor de potencia:</strong> ${datosParaReemplazar.factor_potencia}</div>
                            <div><strong>Ahorro LED estimado:</strong> ${datosParaReemplazar.ahorro_led}</div>
                        </div>
                    </div>
                `;
            }
            
            // Datos econ√≥micos
            if (datosDelSistema.facturacion) {
                contenidoHTML += `
                    <div class="mb-6">
                        <h3 class="font-bold text-lg text-purple-800 mb-3">üí∞ An√°lisis Econ√≥mico</h3>
                        <div class="bg-purple-50 p-4 rounded-lg grid grid-cols-2 gap-4">
                            <div><strong>Costo mensual:</strong> ${datosParaReemplazar.costo_energia_mensual}</div>
                            <div><strong>Costo anual:</strong> ${datosParaReemplazar.costo_energia_anual}</div>
                            <div><strong>Tarifa aplicada:</strong> ${datosParaReemplazar.tarifa_electrica}</div>
                        </div>
                    </div>
                `;
            }
            
            // Datos solares
            if (datosDelSistema.solar) {
                contenidoHTML += `
                    <div class="mb-6">
                        <h3 class="font-bold text-lg text-orange-800 mb-3">‚òÄÔ∏è Potencial Solar</h3>
                        <div class="bg-orange-50 p-4 rounded-lg grid grid-cols-2 gap-4">
                            <div><strong>Radiaci√≥n solar:</strong> ${datosParaReemplazar.radiacion_solar} kWh/m¬≤</div>
                            <div><strong>Potencia recomendada:</strong> ${datosParaReemplazar.potencia_solar_recomendada} kW</div>
                            <div><strong>Ahorro estimado:</strong> ${datosParaReemplazar.ahorro_solar_estimado}</div>
                        </div>
                    </div>
                `;
            }
            
            // Variables disponibles para la plantilla
            contenidoHTML += `
                <div class="mb-6">
                    <h3 class="font-bold text-lg text-gray-800 mb-3">üîß Variables Disponibles para la Plantilla</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-2 text-sm">
            `;
            
            Object.entries(datosParaReemplazar).forEach(([clave, valor]) => {
                if (typeof valor === 'string' || typeof valor === 'number') {
                    contenidoHTML += `<div><code>{{${clave}}}</code> ‚Üí ${valor}</div>`;
                }
            });
            
            contenidoHTML += `
                        </div>
                    </div>
                </div>
                
                <div class="text-center text-sm text-gray-500 mt-8 pt-4 border-t">
                    <p>Vista previa generada el ${new Date().toLocaleString('es-ES')}</p>
                    <p class="mt-1">Los datos se extraen autom√°ticamente de Firebase</p>
                </div>
            </div>
            `;
            
            document.getElementById('contenidoPreview').innerHTML = contenidoHTML;
            document.getElementById('modalPreview').classList.remove('hidden');
        }

        // Guardar registro del informe generado
        async function guardarRegistroInforme(plantillaId, cliente, fecha, formato) {
            try {
                await addDoc(collection(db, 'informes_generados'), {
                    plantilla_id: plantillaId,
                    plantilla_nombre: plantillasDisponibles[plantillaId].nombre,
                    cliente: cliente,
                    fecha_informe: fecha || new Date().toISOString().split('T')[0],
                    formato: formato,
                    datos_utilizados: Object.keys(datosDelSistema),
                    generado_en: new Date().toISOString(),
                    estado: 'completado'
                });
            } catch (error) {
                console.error('Error guardando registro:', error);
            }
        }

        // Cargar historial de informes generados
        async function cargarHistorial() {
            try {
                const q = query(collection(db, 'informes_generados'), orderBy('generado_en', 'desc'), limit(20));
                const snapshot = await getDocs(q);
                
                const container = document.getElementById('historialInformes');
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay informes generados</p>';
                    return;
                }
                
                let html = '<div class="grid gap-4">';
                snapshot.forEach(doc => {
                    const informe = doc.data();
                    html += `
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-lg border-l-4 border-blue-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-lg">${informe.cliente}</h4>
                                    <p class="text-sm text-gray-600">Plantilla: ${informe.plantilla_nombre}</p>
                                    <p class="text-xs text-gray-500">
                                        üìÖ ${new Date(informe.fecha_informe).toLocaleDateString('es-ES')} ‚Ä¢ 
                                        üïí ${new Date(informe.generado_en).toLocaleString('es-ES')}
                                    </p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
                                            ${informe.formato.toUpperCase()}
                                        </span>
                                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">
                                            ${informe.estado}
                                        </span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-gray-700">M√≥dulos utilizados:</p>
                                    <p class="text-xs text-gray-500">${informe.datos_utilizados?.join(', ') || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando historial:', error);
                document.getElementById('historialInformes').innerHTML = '<p class="text-red-500 text-center py-4">‚ùå Error cargando historial</p>';
            }
        }

        // Funciones auxiliares
        function habilitarBotones() {
            const tieneData = Object.keys(datosDelSistema).length > 0;
            const tienePlantillas = Object.keys(plantillasDisponibles).length > 0;
            
            if (tieneData && tienePlantillas) {
                ['btnGenerarDOCX', 'btnGenerarPDF', 'btnPrevisualizar'].forEach(id => {
                    const btn = document.getElementById(id);
                    btn.disabled = false;
                    btn.className = btn.className.replace('opacity-50 cursor-not-allowed', '');
                });
            }
        }

        function formatearMoneda(cantidad) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(cantidad || 0);
        }

        function descargarArchivo(blob, nombre) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombre;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function mostrarStatus(mensaje, tipo) {
            const container = document.getElementById('statusPanel');
            const colores = {
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700',
                warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
                info: 'bg-blue-100 border-blue-400 text-blue-700'
            };
            
            container.innerHTML = `
                <div class="p-4 rounded-lg border-l-4 ${colores[tipo] || colores.info}">
                    ${mensaje}
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 6000);
        }

        // Exponer funciones globalmente
        window.subirPlantilla = subirPlantilla;
        window.subirImagen = subirImagen;
        window.generarDOCX = generarDOCX;
        window.generarPDF = generarPDF;
        window.previsualizarInforme = previsualizarInforme;
        window.actualizarDatos = cargarDatosDelSistema;
        window.cargarHistorial = cargarHistorial;
        window.cerrarPreview = () => document.getElementById('modalPreview').classList.add('hidden');
        window.generarDesdePrevisualizacion = generarDOCX;

        // Establecer fecha por defecto
        document.getElementById('fechaInforme').value = new Date().toISOString().split('T')[0];

        // Inicializar sistema al cargar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üè¢ Iniciando Sistema Automatizado de Informes T√©cnicos');
            console.log('üìã Especificaciones: Firebase + DOCX + PDF + Plantillas + Im√°genes');
            inicializarSistema();
        });

    </script>
</body>
</html>
