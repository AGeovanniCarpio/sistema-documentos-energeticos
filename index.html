<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Auditor√≠as - FUNCIONANDO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: pulse 2s infinite; }
        .success { background: #10b981; }
        .error { background: #ef4444; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg p-6 mb-8">
            <h1 class="text-3xl font-bold mb-2">üî• Sistema de Auditor√≠as Energ√©ticas</h1>
            <p class="opacity-90">Generaci√≥n autom√°tica de documentos - PILOTO FUNCIONAL</p>
            <div id="systemStatus" class="mt-4 text-sm"></div>
        </div>

        <!-- Main Content -->
        <div class="grid lg:grid-cols-2 gap-8">
            
            <!-- Formulario de Datos -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">üìã Datos de Auditor√≠a</h2>
                
                <form id="auditForm">
                    <!-- Cliente -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Cliente</label>
                        <input type="text" id="clienteNombre" class="w-full p-3 border rounded-lg" 
                               placeholder="Nombre del cliente" value="Industrias Ejemplo S.A.">
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Consumo (kWh)</label>
                            <input type="number" id="consumoKwh" class="w-full p-3 border rounded-lg" 
                                   placeholder="15420" value="15420">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Demanda (kW)</label>
                            <input type="number" id="demandaKw" class="w-full p-3 border rounded-lg" 
                                   placeholder="85" value="85">
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Factor de Potencia</label>
                            <input type="number" step="0.01" id="factorPotencia" class="w-full p-3 border rounded-lg" 
                                   placeholder="0.85" value="0.85">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Tarifa</label>
                            <select id="tarifa" class="w-full p-3 border rounded-lg">
                                <option value="GDMTO">GDMTO</option>
                                <option value="GDMTH">GDMTH</option>
                                <option value="OM">OM</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Subida de Archivos -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">üìé Archivos Adjuntos</label>
                        <input type="file" id="fileUpload" multiple class="w-full p-3 border rounded-lg" 
                               accept=".jpg,.jpeg,.png,.pdf,.docx">
                        <div id="fileList" class="mt-2 text-sm text-gray-600"></div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Observaciones</label>
                        <textarea id="observaciones" rows="4" class="w-full p-3 border rounded-lg" 
                                  placeholder="Observaciones adicionales..."></textarea>
                    </div>
                </form>
            </div>
            
            <!-- Panel de Generaci√≥n -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">üìÑ Generar Documento</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Tipo de Plantilla</label>
                    <select id="templateType" class="w-full p-3 border rounded-lg">
                        <option value="basica">üìä Auditor√≠a B√°sica</option>
                        <option value="completa">üî¨ An√°lisis Completo</option>
                        <option value="ejecutivo">üëî Resumen Ejecutivo</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Formato</label>
                    <select id="outputFormat" class="w-full p-3 border rounded-lg">
                        <option value="docx">üìò Word (.docx)</option>
                        <option value="html">üåê HTML</option>
                    </select>
                </div>
                
                <button id="generateBtn" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition">
                    üöÄ Generar Documento
                </button>
                
                <!-- Status y Resultados -->
                <div id="generationStatus" class="mt-4 p-4 rounded-lg hidden"></div>
                
                <!-- C√°lculos Autom√°ticos -->
                <div id="calculations" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h3 class="font-bold mb-2">üßÆ C√°lculos Autom√°ticos</h3>
                    <div id="calculationResults"></div>
                </div>
            </div>
        </div>
        
        <!-- Historial -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">üìö Historial de Documentos</h2>
            <div id="documentHistory" class="space-y-2">
                <p class="text-gray-500">No hay documentos generados a√∫n</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.0/docxtemplater.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ===== CONFIGURACI√ìN =====
        const firebaseConfig = {
            // ‚ö†Ô∏è REEMPLAZAR CON TU CONFIGURACI√ìN REAL
            apiKey: "demo-key",
            authDomain: "demo-project.firebaseapp.com",
            projectId: "demo-project",
            storageBucket: "demo-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "demo-app-id"
        };

        // ===== SISTEMA PRINCIPAL =====
        class AuditSystem {
            constructor() {
                this.app = null;
                this.db = null;
                this.auth = null;
                this.storage = null;
                this.isReady = false;
                this.uploadedFiles = [];
                
                this.init();
            }

            async init() {
                try {
                    // Inicializar Firebase
                    this.app = initializeApp(firebaseConfig);
                    this.db = getFirestore(this.app);
                    this.auth = getAuth(this.app);
                    this.storage = getStorage(this.app);
                    
                    // Auth an√≥nima
                    await signInAnonymously(this.auth);
                    
                    this.isReady = true;
                    this.updateStatus('‚úÖ Sistema listo - Firebase conectado', 'success');
                    this.setupEventListeners();
                    
                } catch (error) {
                    console.warn('Firebase no disponible, modo offline:', error);
                    this.isReady = false;
                    this.updateStatus('‚ö†Ô∏è Modo offline - Sin Firebase', 'error');
                    this.setupEventListeners();
                }
            }

            setupEventListeners() {
                // Generar documento
                document.getElementById('generateBtn').addEventListener('click', () => {
                    this.generateDocument();
                });
                
                // Subida de archivos
                document.getElementById('fileUpload').addEventListener('change', (e) => {
                    this.handleFileUpload(e);
                });
                
                // Validaci√≥n en tiempo real
                ['clienteNombre', 'consumoKwh', 'demandaKw'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => {
                        this.validateForm();
                    });
                });
                
                this.validateForm();
            }

            validateForm() {
                const nombre = document.getElementById('clienteNombre').value.trim();
                const consumo = document.getElementById('consumoKwh').value;
                const demanda = document.getElementById('demandaKw').value;
                
                const isValid = nombre && consumo && demanda;
                const btn = document.getElementById('generateBtn');
                
                btn.disabled = !isValid;
                btn.className = isValid ? 
                    'w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition' :
                    'w-full bg-gray-400 text-white py-3 px-6 rounded-lg font-semibold cursor-not-allowed';
            }

            async handleFileUpload(event) {
                const files = Array.from(event.target.files);
                const fileList = document.getElementById('fileList');
                
                if (files.length === 0) {
                    fileList.innerHTML = '';
                    return;
                }
                
                fileList.innerHTML = `<p class="text-blue-600">üìé ${files.length} archivo(s) seleccionado(s)</p>`;
                
                // Intentar subir a Firebase Storage
                if (this.isReady && this.storage) {
                    try {
                        const uploadPromises = files.map(async (file) => {
                            const storageRef = ref(this.storage, `audits/${Date.now()}_${file.name}`);
                            const snapshot = await uploadBytes(storageRef, file);
                            const downloadURL = await getDownloadURL(snapshot.ref);
                            
                            return {
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                url: downloadURL
                            };
                        });
                        
                        this.uploadedFiles = await Promise.all(uploadPromises);
                        fileList.innerHTML = `<p class="text-green-600">‚úÖ ${files.length} archivo(s) subido(s) a Firebase</p>`;
                        
                    } catch (error) {
                        console.error('Error subiendo archivos:', error);
                        fileList.innerHTML = `<p class="text-red-600">‚ùå Error subiendo archivos</p>`;
                    }
                } else {
                    // Modo local
                    this.uploadedFiles = files.map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        localFile: file
                    }));
                }
            }

            async generateDocument() {
                const btn = document.getElementById('generateBtn');
                const status = document.getElementById('generationStatus');
                
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Generando...';
                status.className = 'mt-4 p-4 rounded-lg bg-blue-100 text-blue-800';
                status.innerHTML = 'üîÑ Procesando datos y generando documento...';
                status.classList.remove('hidden');
                
                try {
                    // Recopilar datos
                    const auditData = this.collectFormData();
                    
                    // Realizar c√°lculos
                    const calculations = this.performCalculations(auditData);
                    
                    // Mostrar c√°lculos
                    this.displayCalculations(calculations);
                    
                    // Combinar datos
                    const fullData = { ...auditData, ...calculations };
                    
                    // Guardar en Firebase si est√° disponible
                    if (this.isReady) {
                        await this.saveToFirebase(fullData);
                    }
                    
                    // Generar documento
                    const templateType = document.getElementById('templateType').value;
                    const outputFormat = document.getElementById('outputFormat').value;
                    
                    const document = await this.createDocument(fullData, templateType, outputFormat);
                    
                    // Descargar
                    this.downloadDocument(document);
                    
                    // Agregar al historial
                    this.addToHistory(document.filename, fullData);
                    
                    status.className = 'mt-4 p-4 rounded-lg bg-green-100 text-green-800';
                    status.innerHTML = `‚úÖ Documento generado: ${document.filename}`;
                    
                } catch (error) {
                    console.error('Error:', error);
                    status.className = 'mt-4 p-4 rounded-lg bg-red-100 text-red-800';
                    status.innerHTML = `‚ùå Error: ${error.message}`;
                    
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'üöÄ Generar Documento';
                }
            }

            collectFormData() {
                return {
                    cliente_nombre: document.getElementById('clienteNombre').value.trim(),
                    consumo_kwh: parseFloat(document.getElementById('consumoKwh').value) || 0,
                    demanda_kw: parseFloat(document.getElementById('demandaKw').value) || 0,
                    factor_potencia: parseFloat(document.getElementById('factorPotencia').value) || 0.9,
                    tarifa: document.getElementById('tarifa').value,
                    observaciones: document.getElementById('observaciones').value.trim(),
                    archivos_adjuntos: this.uploadedFiles,
                    fecha_auditoria: new Date().toLocaleDateString('es-ES'),
                    auditoria_id: `AUD-${Date.now()}`,
                    numero_documento: `DOC-${Date.now()}`
                };
            }

            performCalculations(data) {
                const { consumo_kwh, demanda_kw, factor_potencia, tarifa } = data;
                
                // Tarifas CFE (simplificadas)
                const tarifas = {
                    GDMTO: { demanda: 189.92, energia: 1.947 },
                    GDMTH: { demanda: 189.92, energia: 1.947 },
                    OM: { energia: 0.956 }
                };
                
                const tarifaData = tarifas[tarifa] || tarifas.GDMTO;
                
                // C√°lculos b√°sicos
                const costo_demanda = demanda_kw * (tarifaData.demanda || 0);
                const costo_energia = consumo_kwh * tarifaData.energia;
                const costo_total_mensual = costo_demanda + costo_energia;
                const costo_total_anual = costo_total_mensual * 12;
                
                // Factor de carga
                const factor_carga = (consumo_kwh / (demanda_kw * 8760)) * 100;
                
                // An√°lisis LED simplificado
                const ahorro_led_kwh = consumo_kwh * 0.3; // 30% de ahorro t√≠pico
                const ahorro_led_pesos = ahorro_led_kwh * tarifaData.energia;
                const periodo_recuperacion = 180000 / ahorro_led_pesos; // Inversi√≥n estimada
                
                return {
                    costo_mensual: `$${costo_total_mensual.toLocaleString('es-MX', {minimumFractionDigits: 2})}`,
                    costo_anual: `$${costo_total_anual.toLocaleString('es-MX', {minimumFractionDigits: 2})}`,
                    factor_carga: factor_carga.toFixed(1) + '%',
                    factor_potencia_actual: (factor_potencia * 100).toFixed(1) + '%',
                    ahorro_led_kwh: ahorro_led_kwh.toFixed(0) + ' kWh',
                    ahorro_led_pesos: `$${ahorro_led_pesos.toLocaleString('es-MX', {minimumFractionDigits: 2})}`,
                    periodo_recuperacion: periodo_recuperacion.toFixed(1) + ' a√±os',
                    tarifa_aplicada: tarifa,
                    recomendacion: periodo_recuperacion < 3 ? 'RECOMENDADO' : 'CONSIDERAR'
                };
            }

            displayCalculations(calculations) {
                const calcDiv = document.getElementById('calculations');
                const resultsDiv = document.getElementById('calculationResults');
                
                resultsDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Costo Mensual:</strong> ${calculations.costo_mensual}</div>
                        <div><strong>Costo Anual:</strong> ${calculations.costo_anual}</div>
                        <div><strong>Factor Carga:</strong> ${calculations.factor_carga}</div>
                        <div><strong>Factor Potencia:</strong> ${calculations.factor_potencia_actual}</div>
                        <div><strong>Ahorro LED:</strong> ${calculations.ahorro_led_pesos}</div>
                        <div><strong>Recuperaci√≥n:</strong> ${calculations.periodo_recuperacion}</div>
                    </div>
                `;
                
                calcDiv.classList.remove('hidden');
            }

            async saveToFirebase(data) {
                if (!this.isReady) return;
                
                try {
                    const docRef = await addDoc(collection(this.db, 'audits'), {
                        ...data,
                        created_at: new Date(),
                        user_id: this.auth.currentUser?.uid
                    });
                    
                    console.log('‚úÖ Guardado en Firebase:', docRef.id);
                } catch (error) {
                    console.error('Error guardando en Firebase:', error);
                }
            }

            async createDocument(data, templateType, format) {
                const templates = {
                    basica: this.getBasicTemplate(),
                    completa: this.getCompleteTemplate(),
                    ejecutivo: this.getExecutiveTemplate()
                };
                
                let template = templates[templateType] || templates.basica;
                
                // Reemplazar variables
                Object.keys(data).forEach(key => {
                    const regex = new RegExp(`{{${key}}}`, 'g');
                    template = template.replace(regex, data[key] || '');
                });
                
                const filename = `${data.numero_documento}.${format}`;
                
                if (format === 'docx') {
                    return await this.generateDOCX(template, filename);
                } else {
                    return this.generateHTML(template, filename);
                }
            }

            async generateDOCX(content, filename) {
                // Generar DOCX b√°sico usando docxtemplater
                const zip = new PizZip();
                
                // Estructura m√≠nima DOCX
                const xmlContent = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:body>
        ${content.split('\n').map(line => `
            <w:p>
                <w:r>
                    <w:t>${line}</w:t>
                </w:r>
            </w:p>
        `).join('')}
    </w:body>
</w:document>`;
                
                // Crear estructura ZIP b√°sica
                zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
    <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
    <Default Extension="xml" ContentType="application/xml"/>
    <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);
                
                zip.file('_rels/.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);
                
                zip.file('word/document.xml', xmlContent);
                
                const buffer = zip.generate({ type: 'arraybuffer' });
                
                return {
                    filename: filename,
                    buffer: buffer,
                    contentType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                };
            }

            generateHTML(content, filename) {
                const htmlContent = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Auditor√≠a Energ√©tica</title>
<style>body{font-family:Arial;margin:2cm;} h1{color:#2c5aa0;text-align:center;}</style>
</head><body>
<h1>üî• AUDITOR√çA ENERG√âTICA</h1>
<pre style="white-space: pre-wrap;">${content}</pre>
</body></html>`;
                
                return {
                    filename: filename.replace('.docx', '.html'),
                    buffer: new TextEncoder().encode(htmlContent).buffer,
                    contentType: 'text/html'
                };
            }

            downloadDocument(document) {
                const blob = new Blob([document.buffer], { type: document.contentType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = document.filename;
                link.click();
                URL.revokeObjectURL(url);
            }

            addToHistory(filename, data) {
                const history = document.getElementById('documentHistory');
                
                if (history.children.length === 1 && history.children[0].textContent.includes('No hay documentos')) {
                    history.innerHTML = '';
                }
                
                const item = document.createElement('div');
                item.className = 'p-4 bg-gray-50 rounded-lg';
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-semibold">${filename}</div>
                            <div class="text-sm text-gray-600">${data.cliente_nombre} - ${new Date().toLocaleString('es-ES')}</div>
                        </div>
                        <div class="text-green-600 font-semibold">‚úÖ Generado</div>
                    </div>
                `;
                
                history.insertBefore(item, history.firstChild);
            }

            updateStatus(message, type) {
                const status = document.getElementById('systemStatus');
                const colors = {
                    success: 'text-green-200',
                    error: 'text-red-200',
                    info: 'text-blue-200'
                };
                
                status.className = colors[type] || 'text-white';
                status.textContent = message;
            }

            // Plantillas
            getBasicTemplate() {
                return `AUDITOR√çA ENERG√âTICA B√ÅSICA

CLIENTE: {{cliente_nombre}}
AUDITOR√çA: {{auditoria_id}}
FECHA: {{fecha_auditoria}}

DATOS ENERG√âTICOS
Consumo: {{consumo_kwh}} kWh/a√±o
Demanda: {{demanda_kw}} kW
Factor de Potencia: {{factor_potencia_actual}}
Tarifa: {{tarifa_aplicada}}

AN√ÅLISIS ECON√ìMICO
Costo Mensual: {{costo_mensual}}
Costo Anual: {{costo_anual}}
Factor de Carga: {{factor_carga}}

OPORTUNIDADES LED
Ahorro Estimado: {{ahorro_led_pesos}}/a√±o
Periodo Recuperaci√≥n: {{periodo_recuperacion}}
Recomendaci√≥n: {{recomendacion}}

OBSERVACIONES
{{observaciones}}

Documento: {{numero_documento}}`;
            }

            getCompleteTemplate() {
                return `REPORTE INTEGRAL DE AUDITOR√çA ENERG√âTICA

===== INFORMACI√ìN GENERAL =====
Cliente: {{cliente_nombre}}
ID Auditor√≠a: {{auditoria_id}}
Fecha: {{fecha_auditoria}}

===== AN√ÅLISIS ENERG√âTICO =====
Consumo Anual: {{consumo_kwh}} kWh
Demanda M√°xima: {{demanda_kw}} kW
Factor de Potencia: {{factor_potencia_actual}}
Factor de Carga: {{factor_carga}}
Tarifa El√©ctrica: {{tarifa_aplicada}}

===== AN√ÅLISIS ECON√ìMICO =====
Costo Mensual Actual: {{costo_mensual}}
Costo Anual Total: {{costo_anual}}

===== OPORTUNIDADES DE MEJORA =====
Tecnolog√≠a LED:
- Ahorro Econ√≥mico: {{ahorro_led_pesos}}/a√±o
- Ahorro Energ√©tico: {{ahorro_led_kwh}}/a√±o
- Periodo de Recuperaci√≥n: {{periodo_recuperacion}}
- Recomendaci√≥n: {{recomendacion}}

===== OBSERVACIONES T√âCNICAS =====
{{observaciones}}

===== ARCHIVOS ADJUNTOS =====
Total de archivos: {{archivos_adjuntos.length}} archivo(s)

Documento: {{numero_documento}}
Generado: ${new Date().toLocaleString('es-ES')}`;
            }

            getExecutiveTemplate() {
                return `RESUMEN EJECUTIVO - AUDITOR√çA ENERG√âTICA

Cliente: {{cliente_nombre}}
Fecha: {{fecha_auditoria}}

SITUACI√ìN ACTUAL
‚Ä¢ Costo Anual: {{costo_anual}}
‚Ä¢ Consumo: {{consumo_kwh}} kWh/a√±o
‚Ä¢ Factor de Carga: {{factor_carga}}

OPORTUNIDADES IDENTIFICADAS
‚Ä¢ Ahorro LED: {{ahorro_led_pesos}}/a√±o
‚Ä¢ Recuperaci√≥n: {{periodo_recuperacion}}
‚Ä¢ Recomendaci√≥n: {{recomendacion}}

PR√ìXIMOS PASOS
‚Ä¢ Evaluar propuestas de proveedores LED
‚Ä¢ Implementar mejoras de eficiencia
‚Ä¢ Monitorear resultados

{{observaciones}}

Documento: {{numero_documento}}`;
            }
        }

        // ===== INICIALIZAR SISTEMA =====
        window.addEventListener('DOMContentLoaded', () => {
            window.auditSystem = new AuditSystem();
        });
    </script>
</body>
</html>
