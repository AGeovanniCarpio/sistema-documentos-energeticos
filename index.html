<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Aut√≥nomo de Documentos - Auditor√≠as Energ√©ticas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .autonomous-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-processing { background: #ffc107; animation: blink 1s infinite; }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4">
        <!-- Header Principal -->
        <div class="max-w-7xl mx-auto">
            <div class="glass-effect rounded-3xl p-8 text-center text-white mb-8">
                <h1 class="text-4xl font-bold mb-4">üî• Sistema Aut√≥nomo de Documentos</h1>
                <p class="text-lg opacity-90 mb-4">Generaci√≥n de Reportes de Auditor√≠as Energ√©ticas</p>
                <div class="autonomous-badge text-white px-6 py-2 rounded-full text-sm font-semibold inline-block">
                    üîß COMPLETAMENTE AUT√ìNOMO - SIN APIs EXTERNAS
                </div>
                <div id="systemStatusIndicator" class="mt-4">
                    <span class="status-indicator status-processing"></span>
                    <span id="statusText">Inicializando sistema...</span>
                </div>
            </div>

            <!-- Panel de Control Principal -->
            <div class="grid lg:grid-cols-3 gap-8">
                
                <!-- Columna 1: Generaci√≥n de Documentos -->
                <div class="lg:col-span-2">
                    <div class="card rounded-2xl p-8 shadow-xl">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            üìù Generador de Documentos
                        </h2>
                        
                        <!-- Plantilla -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üìÑ Plantilla del Documento
                            </label>
                            <div class="flex gap-3 mb-3">
                                <select id="systemTemplate" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Seleccionar plantilla del sistema...</option>
                                    <option value="basic_audit">üìä Auditor√≠a B√°sica</option>
                                    <option value="complete_report">üî¨ Reporte Completo</option>
                                    <option value="executive_summary">üëî Resumen Ejecutivo</option>
                                </select>
                                <button id="loadSystemTemplate" class="px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    Cargar
                                </button>
                            </div>
                            <textarea id="templateContent" rows="12" 
                                      class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                      placeholder="Contenido de la plantilla... Use variables como {{cliente_nombre}}, {{auditoria_id}}, etc."></textarea>
                            <div class="text-xs text-gray-500 mt-2">
                                üí° Variables disponibles: {{cliente_nombre}}, {{auditoria_id}}, {{consumo_total}}, {{ahorro_pesos_anual_led}}, {{roi_led}}, etc.
                            </div>
                        </div>

                        <!-- Datos de la Auditor√≠a -->
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üÜî ID de Auditor√≠a</label>
                                <input type="text" id="auditId" class="w-full p-3 border border-gray-300 rounded-lg" 
                                       placeholder="ej: AUD-2025-001">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìã Tipo de Documento</label>
                                <select id="documentType" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="">Seleccionar...</option>
                                    <option value="perfil_energetico">üìä Perfil Energ√©tico</option>
                                    <option value="analisis_completo">üî¨ An√°lisis Completo</option>
                                    <option value="informe_ejecutivo">üëî Informe Ejecutivo</option>
                                    <option value="certificacion">üèÜ Certificaci√≥n</option>
                                </select>
                            </div>
                        </div>

                        <!-- Configuraci√≥n Avanzada -->
                        <div class="bg-gray-50 rounded-xl p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">‚öôÔ∏è Configuraci√≥n Avanzada</h3>
                            
                            <div class="grid md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Formato</label>
                                    <select id="outputFormat" class="w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="docx">üìò Word (.docx)</option>
                                        <option value="html">üåê HTML</option>
                                        <option value="rtf">üìù RTF</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">C√°lculos</label>
                                    <select id="includeCalculations" class="w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="full">üî¨ Completos</option>
                                        <option value="basic">üìä B√°sicos</option>
                                        <option value="none">‚ùå Ninguno</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Opciones</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" id="autoSave" checked class="mr-2"> Guardar en servidor
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" id="includeHeader" checked class="mr-2"> Incluir encabezado
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Datos de C√°lculo -->
                            <div class="grid md:grid-cols-4 gap-3">
                                <input type="number" id="consumoKwh" placeholder="Consumo (kWh)" class="p-2 border rounded" value="15420">
                                <input type="number" id="demandaKw" placeholder="Demanda (kW)" class="p-2 border rounded" value="85">
                                <input type="number" id="factorPotencia" placeholder="F.P." step="0.01" class="p-2 border rounded" value="0.82">
                                <select id="tarifaSelect" class="p-2 border rounded">
                                    <option value="GDMTO">GDMTO</option>
                                    <option value="GDMTH">GDMTH</option>
                                    <option value="OM">OM</option>
                                </select>
                            </div>
                        </div>

                        <!-- Botones de Acci√≥n -->
                        <div class="flex gap-3">
                            <button id="generateBtn" disabled
                                    class="flex-1 bg-gradient-to-r from-green-500 to-teal-500 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:from-green-600 hover:to-teal-600 transition-all disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed">
                                üöÄ Generar Documento Aut√≥nomo
                            </button>
                            <button id="previewBtn" 
                                    class="px-6 py-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-colors">
                                üëÅÔ∏è Preview
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Columna 2: Panel de Control y Estad√≠sticas -->
                <div class="space-y-6">
                    
                    <!-- Estado del Sistema -->
                    <div class="card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Estado del Sistema</h3>
                        <div id="systemStats" class="space-y-3">
                            <div class="flex justify-between text-sm">
                                <span>Documentos generados:</span>
                                <span id="docsCount" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Plantillas guardadas:</span>
                                <span id="templatesCount" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Sistema:</span>
                                <span class="text-green-600 font-semibold">üü¢ Operativo</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Almacenamiento:</span>
                                <span class="text-blue-600 font-semibold">‚òÅÔ∏è Firebase</span>
                            </div>
                        </div>
                    </div>

                    <!-- Plantillas Guardadas -->
                    <div class="card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìö Plantillas Guardadas</h3>
                        <div id="savedTemplates" class="space-y-2">
                            <p class="text-gray-500 text-sm">Cargando plantillas...</p>
                        </div>
                        <button id="saveCurrentTemplate" 
                                class="w-full mt-4 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                            üíæ Guardar Plantilla Actual
                        </button>
                    </div>

                    <!-- Documentos Recientes -->
                    <div class="card rounded-2xl p-6 shadow-xl">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìã Documentos Recientes</h3>
                        <div id="recentDocuments" class="space-y-2">
                            <p class="text-gray-500 text-sm">No hay documentos generados</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de Status -->
            <div class="mt-8">
                <div id="statusPanel" class="glass-effect rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <span id="currentStatus">‚úÖ Sistema listo para generar documentos</span>
                        </div>
                        <div class="text-sm opacity-75">
                            <span id="lastActivity">√öltima actividad: Nunca</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts Externos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.0/docxtemplater.min.js"></script>

    <!-- Sistema Principal -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===== SISTEMA PRINCIPAL =====
        class AutonomousAuditSystem {
            constructor() {
                this.db = null;
                this.auth = null;
                this.userId = null;
                this.isReady = false;
                
                // Estad√≠sticas
                this.stats = {
                    documentsGenerated: 0,
                    templatesCreated: 0,
                    startTime: new Date()
                };
                
                // Templates del sistema
                this.systemTemplates = {
                    basic_audit: `AUDITOR√çA ENERG√âTICA B√ÅSICA

INFORMACI√ìN DEL CLIENTE
Empresa: {{cliente_nombre}}
Direcci√≥n: {{cliente_direccion}}
Tel√©fono: {{cliente_telefono}}

DATOS DE LA AUDITOR√çA
ID: {{auditoria_id}}
Fecha: {{fecha_auditoria}}
Auditor: {{auditor_nombre}}

AN√ÅLISIS ENERG√âTICO
Consumo Total Anual: {{consumo_total}}
Costo Anual Actual: {{costo_anual_actual}}
Tarifa Aplicada: {{tarifa_aplicada}}

OPORTUNIDADES DE AHORRO
Ahorro Proyectado: {{ahorro_pesos_anual_led}}
ROI Estimado: {{roi_led}}
Periodo de Recuperaci√≥n: {{periodo_recuperacion_led}} a√±os

CONCLUSIONES
{{resumen_ejecutivo}}

Documento: {{numero_documento}}
Generado: {{fecha_generacion}}`,

                    complete_report: `REPORTE INTEGRAL DE AUDITOR√çA ENERG√âTICA

RESUMEN EJECUTIVO
{{resumen_ejecutivo}}

INFORMACI√ìN GENERAL
Cliente: {{cliente_nombre}}
Direcci√≥n: {{cliente_direccion}}
Contacto: {{cliente_telefono}} | {{cliente_email}}
Auditor√≠a ID: {{auditoria_id}}
Fecha de Auditor√≠a: {{fecha_auditoria}}
Auditor Responsable: {{auditor_nombre}}

AN√ÅLISIS ENERG√âTICO DETALLADO
Consumo Total Anual: {{consumo_total}}
Demanda M√°xima: {{demanda_maxima}}
Factor de Carga: {{factor_carga}}
Factor de Potencia: {{factor_potencia_actual}}
Intensidad Energ√©tica: {{intensidad_energetica}} kWh/m¬≤

AN√ÅLISIS TARIFARIO
Tarifa El√©ctrica: {{tarifa_aplicada}}
Costo Mensual Promedio: {{costo_mensual_actual}}
Costo Anual Total: {{costo_anual_actual}}
Costo Promedio por kWh: {{costo_kwh_promedio}}

AN√ÅLISIS DE MEJORAS - ILUMINACI√ìN LED
Ahorro Energ√©tico Anual: {{ahorro_kwh_anual_led}} kWh
Ahorro Econ√≥mico Anual: {{ahorro_pesos_anual_led}}
Porcentaje de Reducci√≥n: {{ahorro_porcentaje_led}}
Periodo de Recuperaci√≥n: {{periodo_recuperacion_led}} a√±os
ROI Proyectado: {{roi_led}}
VAN del Proyecto: {{van_led}}
TIR: {{tir_led}}

IMPACTO AMBIENTAL
Reducci√≥n de Emisiones CO‚ÇÇ: {{reduccion_co2_ton}} toneladas/a√±o
Equivalente en √Årboles: {{reduccion_co2_arboles}} √°rboles plantados

RECOMENDACI√ìN
{{recomendacion_led}}
{{justificacion_led}}

CONCLUSIONES
El an√°lisis energ√©tico identifica oportunidades significativas de ahorro.
Se recomienda implementar las medidas seg√∫n prioridad econ√≥mica.

Documento: {{numero_documento}}
Generado: {{fecha_generacion}} {{hora_generacion}}`,

                    executive_summary: `RESUMEN EJECUTIVO - AUDITOR√çA ENERG√âTICA
{{cliente_nombre}}

SITUACI√ìN ACTUAL
‚Ä¢ Consumo Anual: {{consumo_total}}
‚Ä¢ Costo Anual: {{costo_anual_actual}}
‚Ä¢ Tarifa: {{tarifa_aplicada}}

OPORTUNIDADES IDENTIFICADAS
‚Ä¢ Potencial de Ahorro: {{ahorro_pesos_anual_led}}
‚Ä¢ ROI Proyectado: {{roi_led}}
‚Ä¢ Periodo de Recuperaci√≥n: {{periodo_recuperacion_led}} a√±os

RECOMENDACIONES PRIORITARIAS
1. Modernizaci√≥n del sistema de iluminaci√≥n
2. Correcci√≥n del factor de potencia
3. Optimizaci√≥n de sistemas HVAC

PR√ìXIMOS PASOS
‚Ä¢ Evaluar propuestas de proveedores
‚Ä¢ Definir cronograma de implementaci√≥n
‚Ä¢ Establecer m√©tricas de seguimiento

{{resumen_ejecutivo}}

Auditor: {{auditor_nombre}}
Fecha: {{fecha_auditoria}}
Documento: {{numero_documento}}`
                };
                
                this.init();
            }

            async init() {
                try {
                    this.updateStatus('üîÑ Inicializando sistema aut√≥nomo...', 'processing');
                    
                    await this.initFirebase();
                    this.setupEventListeners();
                    await this.loadUserData();
                    
                    this.isReady = true;
                    this.updateStatus('‚úÖ Sistema aut√≥nomo listo - Sin APIs externas', 'online');
                    this.updateStats();
                    
                } catch (error) {
                    console.error('Error inicializando:', error);
                    this.updateStatus('‚ùå Error en inicializaci√≥n', 'offline');
                }
            }

            async initFirebase() {
                // Configuraci√≥n Firebase (reemplazar con la real)
                const firebaseConfig = {
                    apiKey: "demo-key",
                    authDomain: "demo-project.firebaseapp.com",
                    projectId: "demo-project-id",
                    storageBucket: "demo-project.appspot.com",
                    messagingSenderId: "123456789",
                    appId: "demo-app-id"
                };

                try {
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);
                    
                    await signInAnonymously(this.auth);
                    
                    return new Promise((resolve, reject) => {
                        onAuthStateChanged(this.auth, (user) => {
                            if (user) {
                                this.userId = user.uid;
                                console.log('üî• Firebase conectado:', this.userId);
                                resolve();
                            } else {
                                reject(new Error('Auth failed'));
                            }
                        });
                    });
                } catch (error) {
                    // Modo demo sin Firebase
                    console.warn('Firebase no disponible, modo demo activado');
                    this.userId = 'demo-user';
                    this.db = null;
                }
            }

            setupEventListeners() {
                // Cargar plantilla del sistema
                document.getElementById('loadSystemTemplate').addEventListener('click', () => {
                    const templateId = document.getElementById('systemTemplate').value;
                    if (templateId && this.systemTemplates[templateId]) {
                        document.getElementById('templateContent').value = this.systemTemplates[templateId];
                        this.validateForm();
                        this.updateStatus('üìÑ Plantilla del sistema cargada', 'online');
                    }
                });

                // Validaci√≥n de formulario
                ['templateContent', 'auditId', 'documentType'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => this.validateForm());
                });

                // Generar documento
                document.getElementById('generateBtn').addEventListener('click', () => this.generateDocument());

                // Preview
                document.getElementById('previewBtn').addEventListener('click', () => this.showPreview());

                // Guardar plantilla
                document.getElementById('saveCurrentTemplate').addEventListener('click', () => this.saveTemplate());
            }

            validateForm() {
                const templateContent = document.getElementById('templateContent').value.trim();
                const auditId = document.getElementById('auditId').value.trim();
                const documentType = document.getElementById('documentType').value;
                
                const isValid = templateContent.length > 50 && auditId && documentType;
                const generateBtn = document.getElementById('generateBtn');
                
                generateBtn.disabled = !isValid;
                generateBtn.textContent = isValid ? 
                    'üöÄ Generar Documento Aut√≥nomo' : 
                    '‚ö†Ô∏è Complete todos los campos';
            }

            async generateDocument() {
                if (!this.isReady) return;

                const templateContent = document.getElementById('templateContent').value.trim();
                const auditId = document.getElementById('auditId').value.trim();
                const documentType = document.getElementById('documentType').value;
                const outputFormat = document.getElementById('outputFormat').value;
                const includeCalculations = document.getElementById('includeCalculations').value;

                this.updateStatus('üîÑ Generando documento...', 'processing');

                try {
                    // Preparar datos del documento
                    let documentData = this.getDocumentData(auditId, documentType);
                    
                    // Agregar c√°lculos si se solicita
                    if (includeCalculations !== 'none') {
                        const calculations = this.performCalculations();
                        documentData = { ...documentData, ...calculations };
                    }

                    // Procesar plantilla
                    const processedContent = this.processTemplate(templateContent, documentData);

                    // Generar documento seg√∫n formato
                    let result;
                    switch (outputFormat) {
                        case 'docx':
                            result = await this.generateDOCX(processedContent, documentData);
                            break;
                        case 'html':
                            result = this.generateHTML(processedContent, documentData);
                            break;
                        case 'rtf':
                            result = this.generateRTF(processedContent, documentData);
                            break;
                    }

                    // Guardar si est√° habilitado
                    if (document.getElementById('autoSave').checked && this.db) {
                        await this.saveDocument(result, documentData);
                    }

                    // Descargar archivo
                    this.downloadFile(result.buffer, result.filename, result.contentType);

                    // Actualizar estad√≠sticas
                    this.stats.documentsGenerated++;
                    this.updateStats();
                    this.addToRecentDocuments(result.filename, documentData);
                    
                    this.updateStatus(`‚úÖ Documento generado: ${result.filename}`, 'online');
                    
                } catch (error) {
                    console.error('Error generando documento:', error);
                    this.updateStatus(`‚ùå Error: ${error.message}`, 'offline');
                }
            }

            async generateDOCX(content, documentData) {
                try {
                    // Crear documento DOCX b√°sico
                    const zip = new PizZip();
                    
                    // Estructura m√≠nima DOCX
                    zip.file('[Content_Types].xml', this.getContentTypesXML());
                    zip.file('_rels/.rels', this.getMainRelsXML());
                    zip.file('word/_rels/document.xml.rels', this.getDocRelsXML());
                    zip.file('word/document.xml', this.createWordXML(content, documentData));
                    zip.file('word/styles.xml', this.getStylesXML());
                    zip.file('docProps/core.xml', this.getCorePropsXML(documentData));
                    zip.file('docProps/app.xml', this.getAppPropsXML());

                    const buffer = zip.generate({
                        type: 'arraybuffer',
                        mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                    });

                    return {
                        buffer: buffer,
                        filename: `${documentData.numero_documento}.docx`,
                        contentType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                    };
                } catch (error) {
                    throw new Error(`Error generando DOCX: ${error.message}`);
                }
            }

            generateHTML(content, documentData) {
                const htmlContent = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>${documentData.numero_documento}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 21cm; margin: 0 auto; padding: 2cm; }
        h1 { color: #2c5aa0; text-align: center; }
        h2 { color: #2c5aa0; border-bottom: 1px solid #ccc; }
        .data-field { display: flex; justify-content: space-between; padding: 5px 0; }
        .label { font-weight: bold; }
    </style>
</head>
<body>
    <h1>üìä REPORTE DE AUDITOR√çA ENERG√âTICA</h1>
    <p style="text-align: center; margin-bottom: 30px;">
        <strong>Documento:</strong> ${documentData.numero_documento}<br>
        <strong>Generado:</strong> ${new Date().toLocaleString('es-ES')}
    </p>
    ${this.formatContentForHTML(content)}
    <footer style="margin-top: 40px; text-align: center; border-top: 1px solid #ccc; padding-top: 20px; font-size: 12px; color: #666;">
        <p><strong>Sistema Aut√≥nomo de Documentos</strong></p>
        <p>Generado sin APIs externas ‚Ä¢ Almacenado en servidor propio</p>
    </footer>
</body>
</html>`;

                return {
                    buffer: new TextEncoder().encode(htmlContent).buffer,
                    filename: `${documentData.numero_documento}.html`,
                    contentType: 'text/html'
                };
            }

            generateRTF(content, documentData) {
                let rtf = '{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0 Times New Roman;}}';
                rtf += '\\qc\\b\\fs32 REPORTE DE AUDITOR√çA ENERG√âTICA\\par\\par';
                rtf += `\\qc\\fs24 Documento: ${documentData.numero_documento}\\par\\par`;
                
                content.split('\n').forEach(line => {
                    const trimmed = line.trim();
                    if (trimmed) {
                        if (trimmed === trimmed.toUpperCase() && trimmed.length > 5) {
                            rtf += `\\b\\fs28 ${trimmed}\\par\\par`;
                        } else {
                            rtf += `${trimmed}\\par`;
                        }
                    }
                });
                
                rtf += '}';

                return {
                    buffer: new TextEncoder().encode(rtf).buffer,
                    filename: `${documentData.numero_documento}.rtf`,
                    contentType: 'application/rtf'
                };
            }

            // ===== M√âTODOS DE UTILIDAD =====
            
            getDocumentData(auditId, documentType) {
                const now = new Date();
                return {
                    auditoria_id: auditId,
                    tipo_documento: documentType,
                    numero_documento: `${documentType.toUpperCase()}-${auditId}-${now.getTime()}`,
                    fecha_generacion: now.toLocaleDateString('es-ES'),
                    hora_generacion: now.toLocaleTimeString('es-ES'),
                    cliente_nombre: 'Cliente Ejemplo S.A. de C.V.',
                    cliente_direccion: 'Av. Ejemplo 123, Ciudad, Estado',
                    cliente_telefono: '+52 33 1234-5678',
                    cliente_email: 'contacto@ejemplo.com',
                    fecha_auditoria: now.toLocaleDateString('es-ES'),
                    auditor_nombre: 'Ing. Auditor Ejemplo',
                    consumo_total: '15,420 kWh/a√±o',
                    costo_anual_actual: '$284,567.00',
                    tarifa_aplicada: 'GDMTO - Gran Demanda Media Tensi√≥n',
                    resumen_ejecutivo: 'Auditor√≠a energ√©tica completada con identificaci√≥n de oportunidades significativas de ahorro. Sistema generado de forma completamente aut√≥noma.'
                };
            }

            performCalculations() {
                // Datos de entrada
                const consumo = parseFloat(document.getElementById('consumoKwh').value) || 15420;
                const demanda = parseFloat(document.getElementById('demandaKw').value) || 85;
                const fp = parseFloat(document.getElementById('factorPotencia').value) || 0.82;
                const tarifa = document.getElementById('tarifaSelect').value;

                // C√°lculos energ√©ticos
                const factorCarga = (consumo / (demanda * 8760)) * 100;
                const intensidadEnergetica = consumo / 2500; // Asumiendo 2500 m¬≤
                
                // C√°lculos de iluminaci√≥n LED
                const potenciaActual = 150; // W por luminaria
                const potenciaLED = 50; // W por luminaria LED
                const cantidadLuminarias = 200;
                const horasAnuales = 3650;
                
                const consumoActualLED = (potenciaActual * cantidadLuminarias * horasAnuales) / 1000;
                const consumoLED = (potenciaLED * cantidadLuminarias * horasAnuales) / 1000;
                const ahorroKwh = consumoActualLED - consumoLED;
                const ahorroPesos = ahorroKwh * 2.2; // Costo promedio kWh
                const ahorroPortcentaje = (ahorroKwh / consumoActualLED) * 100;
                
                // An√°lisis financiero
                const inversion = 180000;
                const periodoRecuperacion = inversion / ahorroPesos;
                const roi = ((ahorroPesos * 10 - inversion) / inversion) * 100;
                const van = this.calculateVAN([ahorroPesos, ahorroPesos, ahorroPesos, ahorroPesos, ahorroPesos], 0.12, inversion);
                const tir = this.calculateTIR([-inversion, ahorroPesos, ahorroPesos, ahorroPesos, ahorroPesos, ahorroPesos]);
                
                // Impacto ambiental
                const reduccionCO2 = ahorroKwh * 0.000527; // Factor emisi√≥n CFE
                const equivalenteArboles = reduccionCO2 * 2.5;

                return {
                    // Indicadores energ√©ticos
                    factor_carga: factorCarga.toFixed(1) + '%',
                    factor_potencia_actual: (fp * 100).toFixed(1) + '%',
                    intensidad_energetica: intensidadEnergetica.toFixed(1),
                    costo_kwh_promedio: '$2.20',
                    costo_mensual_actual: '$23,714.00',
                    
                    // An√°lisis LED
                    ahorro_kwh_anual_led: this.formatNumber(ahorroKwh) + ' kWh',
                    ahorro_pesos_anual_led: this.formatCurrency(ahorroPesos),
                    ahorro_porcentaje_led: ahorroPortcentaje.toFixed(1) + '%',
                    periodo_recuperacion_led: periodoRecuperacion.toFixed(1),
                    roi_led: roi.toFixed(1) + '%',
                    van_led: this.formatCurrency(van),
                    tir_led: (tir * 100).toFixed(1) + '%',
                    
                    // Recomendaciones
                    recomendacion_led: this.getRecommendation(periodoRecuperacion, roi),
                    justificacion_led: this.getJustification(periodoRecuperacion, roi),
                    
                    // Impacto ambiental
                    reduccion_co2_ton: reduccionCO2.toFixed(2),
                    reduccion_co2_arboles: equivalenteArboles.toFixed(1)
                };
            }

            calculateVAN(flujos, tasa, inversion) {
                let van = -inversion;
                flujos.forEach((flujo, periodo) => {
                    van += flujo / Math.pow(1 + tasa, periodo + 1);
                });
                return van;
            }

            calculateTIR(flujos) {
                let tir = 0.1;
                for (let i = 0; i < 100; i++) {
                    const van = flujos.reduce((sum, flujo, periodo) => 
                        sum + flujo / Math.pow(1 + tir, periodo), 0);
                    const derivada = flujos.reduce((sum, flujo, periodo) => 
                        sum - (periodo * flujo) / Math.pow(1 + tir, periodo + 1), 0);
                    
                    const nuevaTir = tir - van / derivada;
                    if (Math.abs(nuevaTir - tir) < 0.0001) break;
                    tir = nuevaTir;
                }
                return tir;
            }

            getRecommendation(periodo, roi) {
                if (periodo <= 2 && roi > 50) return 'ALTAMENTE RECOMENDADO';
                if (periodo <= 4 && roi > 20) return 'RECOMENDADO';
                if (periodo <= 6 && roi > 0) return 'CONSIDERAR';
                return 'NO RECOMENDADO';
            }

            getJustification(periodo, roi) {
                if (periodo <= 2 && roi > 50) return 'Excelente retorno de inversi√≥n con periodo de recuperaci√≥n muy corto.';
                if (periodo <= 4 && roi > 20) return 'Buen retorno de inversi√≥n en periodo aceptable.';
                if (periodo <= 6 && roi > 0) return 'Retorno positivo pero periodo de recuperaci√≥n largo.';
                return 'Periodo de recuperaci√≥n muy largo o retorno insuficiente.';
            }

            processTemplate(template, data) {
                let processed = template;
                Object.keys(data).forEach(key => {
                    const regex = new RegExp(`{{${key}}}`, 'g');
                    processed = processed.replace(regex, data[key] || '');
                });
                return processed.replace(/{{[^}]*}}/g, '[No disponible]');
            }

            formatContentForHTML(content) {
                return content.split('\n').map(line => {
                    const trimmed = line.trim();
                    if (!trimmed) return '<br>';
                    
                    if (trimmed === trimmed.toUpperCase() && trimmed.length > 5) {
                        return `<h2>${trimmed}</h2>`;
                    } else if (trimmed.includes(':')) {
                        const [label, value] = trimmed.split(':');
                        return `<div class="data-field"><span class="label">${label.trim()}:</span><span>${value ? value.trim() : ''}</span></div>`;
                    } else {
                        return `<p>${trimmed}</p>`;
                    }
                }).join('\n');
            }

            // ===== M√âTODOS XML PARA DOCX =====
            
            getContentTypesXML() {
                return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
    <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
    <Default Extension="xml" ContentType="application/xml"/>
    <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
    <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
    <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
    <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
</Types>`;
            }

            getMainRelsXML() {
                return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
    <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
    <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
</Relationships>`;
            }

            getDocRelsXML() {
                return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;
            }

            createWordXML(content, documentData) {
                let xml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:body>`;
                
                // T√≠tulo principal
                xml += `
        <w:p>
            <w:pPr><w:jc w:val="center"/><w:spacing w:after="320"/></w:pPr>
            <w:r><w:rPr><w:b/><w:sz w:val="32"/><w:color w:val="2c5aa0"/></w:rPr>
            <w:t>REPORTE DE AUDITOR√çA ENERG√âTICA</w:t></w:r>
        </w:p>`;
                
                // Informaci√≥n del documento
                xml += `
        <w:p>
            <w:pPr><w:jc w:val="center"/><w:spacing w:after="480"/></w:pPr>
            <w:r><w:rPr><w:sz w:val="24"/></w:rPr>
            <w:t>Documento: ${documentData.numero_documento}</w:t></w:r>
        </w:p>`;
                
                // Badge aut√≥nomo
                xml += `
        <w:p>
            <w:pPr><w:jc w:val="center"/><w:spacing w:after="480"/></w:pPr>
            <w:r><w:rPr><w:b/><w:sz w:val="20"/><w:color w:val="28a745"/></w:rPr>
            <w:t>üîß SISTEMA COMPLETAMENTE AUT√ìNOMO</w:t></w:r>
        </w:p>`;
                
                // Contenido principal
                content.split('\n').forEach(line => {
                    const trimmed = line.trim();
                    if (!trimmed) return;
                    
                    if (trimmed === trimmed.toUpperCase() && trimmed.length > 5) {
                        xml += `
        <w:p>
            <w:pPr><w:spacing w:before="240" w:after="120"/></w:pPr>
            <w:r><w:rPr><w:b/><w:sz w:val="28"/><w:color w:val="2c5aa0"/></w:rPr>
            <w:t>${trimmed}</w:t></w:r>
        </w:p>`;
                    } else if (trimmed.includes(':')) {
                        const [label, value] = trimmed.split(':');
                        xml += `
        <w:p>
            <w:pPr><w:spacing w:after="80"/></w:pPr>
            <w:r><w:rPr><w:b/></w:rPr><w:t>${label.trim()}:</w:t></w:r>
            <w:r><w:t xml:space="preserve"> ${value ? value.trim() : ''}</w:t></w:r>
        </w:p>`;
                    } else {
                        xml += `
        <w:p>
            <w:pPr><w:spacing w:after="160"/></w:pPr>
            <w:r><w:t>${trimmed}</w:t></w:r>
        </w:p>`;
                    }
                });
                
                // Footer
                xml += `
        <w:p>
            <w:pPr><w:jc w:val="center"/><w:spacing w:before="480"/>
            <w:pBdr><w:top w:val="single" w:sz="4" w:space="1" w:color="cccccc"/></w:pBdr></w:pPr>
            <w:r><w:rPr><w:sz w:val="18"/><w:color w:val="666666"/></w:rPr>
            <w:t>Sistema Aut√≥nomo ‚Ä¢ Sin APIs Externas ‚Ä¢ ${new Date().toLocaleString('es-ES')}</w:t></w:r>
        </w:p>`;
                
                xml += `    </w:body></w:document>`;
                return xml;
            }

            getStylesXML() {
                return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:docDefaults>
        <w:rPrDefault>
            <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/><w:sz w:val="22"/></w:rPr>
        </w:rPrDefault>
    </w:docDefaults>
</w:styles>`;
            }

            getCorePropsXML(documentData) {
                return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <dc:title>${documentData.numero_documento}</dc:title>
    <dc:creator>Sistema Aut√≥nomo de Documentos</dc:creator>
    <dcterms:created xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:created>
    <dcterms:modified xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:modified>
</cp:coreProperties>`;
            }

            getAppPropsXML() {
                return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties">
    <Application>Sistema Aut√≥nomo de Documentos</Application>
    <DocSecurity>0</DocSecurity>
    <ScaleCrop>false</ScaleCrop>
    <LinksUpToDate>false</LinksUpToDate>
    <SharedDoc>false</SharedDoc>
    <HyperlinksChanged>false</HyperlinksChanged>
    <AppVersion>1.0</AppVersion>
</Properties>`;
            }

            // ===== GESTI√ìN DE DATOS =====
            
            async saveDocument(document, metadata) {
                if (!this.db) return;
                
                try {
                    const docData = {
                        filename: document.filename,
                        contentType: document.contentType,
                        size: document.buffer.byteLength,
                        data: this.arrayBufferToBase64(document.buffer),
                        metadata: {
                            ...metadata,
                            createdAt: new Date().toISOString(),
                            createdBy: this.userId
                        }
                    };
                    
                    await addDoc(collection(this.db, `documents/${this.userId}/files`), docData);
                    console.log('üìÅ Documento guardado en servidor');
                } catch (error) {
                    console.error('Error guardando documento:', error);
                }
            }

            async saveTemplate() {
                const templateContent = document.getElementById('templateContent').value.trim();
                if (!templateContent) return;
                
                const name = prompt('Nombre de la plantilla:');
                if (!name) return;
                
                try {
                    const templateData = {
                        name: name,
                        content: templateContent,
                        createdAt: new Date().toISOString(),
                        createdBy: this.userId
                    };
                    
                    if (this.db) {
                        await addDoc(collection(this.db, `templates/${this.userId}/saved`), templateData);
                    }
                    
                    this.stats.templatesCreated++;
                    this.updateStats();
                    this.updateStatus(`‚úÖ Plantilla "${name}" guardada`, 'online');
                    this.loadSavedTemplates();
                    
                } catch (error) {
                    console.error('Error guardando plantilla:', error);
                    this.updateStatus('‚ùå Error guardando plantilla', 'offline');
                }
            }

            async loadSavedTemplates() {
                if (!this.db) return;
                
                try {
                    const templatesRef = collection(this.db, `templates/${this.userId}/saved`);
                    const querySnapshot = await getDocs(query(templatesRef, orderBy('createdAt', 'desc'), limit(10)));
                    
                    const container = document.getElementById('savedTemplates');
                    container.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-sm">No hay plantillas guardadas</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const template = doc.data();
                        const templateDiv = document.createElement('div');
                        templateDiv.className = 'flex justify-between items-center p-2 bg-gray-50 rounded mb-2';
                        templateDiv.innerHTML = `
                            <span class="text-sm font-medium">${template.name}</span>
                            <button onclick="window.auditSystem.loadTemplate('${doc.id}')" 
                                    class="text-xs bg-blue-500 text-white px-2 py-1 rounded">
                                Cargar
                            </button>
                        `;
                        container.appendChild(templateDiv);
                    });
                    
                } catch (error) {
                    console.error('Error cargando plantillas:', error);
                }
            }

            async loadUserData() {
                await this.loadSavedTemplates();
            }

            // ===== UI HELPERS =====
            
            showPreview() {
                const templateContent = document.getElementById('templateContent').value.trim();
                const auditId = document.getElementById('auditId').value.trim() || 'PREVIEW-001';
                const documentType = document.getElementById('documentType').value || 'preview';
                
                if (!templateContent) {
                    alert('Primero ingrese el contenido de la plantilla');
                    return;
                }
                
                // Generar datos de preview
                let documentData = this.getDocumentData(auditId, documentType);
                const includeCalculations = document.getElementById('includeCalculations').value;
                
                if (includeCalculations !== 'none') {
                    const calculations = this.performCalculations();
                    documentData = { ...documentData, ...calculations };
                }
                
                // Procesar plantilla
                const processedContent = this.processTemplate(templateContent, documentData);
                
                // Mostrar modal de preview
                this.showPreviewModal(processedContent, documentData);
            }

            showPreviewModal(content, data) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center p-6 border-b">
                            <h3 class="text-xl font-bold">üëÅÔ∏è Preview del Documento</h3>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div class="p-6 overflow-y-auto flex-1">
                            <div class="prose max-w-none">
                                ${this.formatContentForHTML(content)}
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 bg-gray-500 text-white rounded-lg">
                                Cerrar
                            </button>
                            <button onclick="window.auditSystem.generateDocument(); this.closest('.fixed').remove();" 
                                    class="px-4 py-2 bg-green-500 text-white rounded-lg">
                                Generar Documento
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            addToRecentDocuments(filename, metadata) {
                const container = document.getElementById('recentDocuments');
                
                // Limpiar mensaje inicial
                if (container.textContent.includes('No hay documentos')) {
                    container.innerHTML = '';
                }
                
                const docDiv = document.createElement('div');
                docDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2';
                docDiv.innerHTML = `
                    <div>
                        <div class="font-medium text-sm">${filename}</div>
                        <div class="text-xs text-gray-500">${new Date().toLocaleString('es-ES')}</div>
                    </div>
                    <div class="text-xs text-green-600 font-semibold">‚úÖ Generado</div>
                `;
                
                container.insertBefore(docDiv, container.firstChild);
                
                // Mantener solo los √∫ltimos 5
                while (container.children.length > 5) {
                    container.removeChild(container.lastChild);
                }
            }

            updateStatus(message, type) {
                const indicator = document.getElementById('systemStatusIndicator');
                const statusText = document.getElementById('statusText');
                const currentStatus = document.getElementById('currentStatus');
                const lastActivity = document.getElementById('lastActivity');
                
                if (statusText) statusText.textContent = message;
                if (currentStatus) currentStatus.textContent = message;
                if (lastActivity) lastActivity.textContent = `√öltima actividad: ${new Date().toLocaleTimeString('es-ES')}`;
                
                // Actualizar indicador visual
                if (indicator) {
                    const dot = indicator.querySelector('.status-indicator');
                    if (dot) {
                        dot.className = `status-indicator status-${type}`;
                    }
                }
            }

            updateStats() {
                document.getElementById('docsCount').textContent = this.stats.documentsGenerated;
                document.getElementById('templatesCount').textContent = this.stats.templatesCreated;
            }

            // ===== UTILIDADES =====
            
            downloadFile(buffer, filename, contentType) {
                const blob = new Blob([buffer], { type: contentType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
            }

            arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }

            formatNumber(num) {
                return new Intl.NumberFormat('es-MX').format(num);
            }

            formatCurrency(num) {
                return new Intl.NumberFormat('es-MX', {
                    style: 'currency',
                    currency: 'MXN'
                }).format(num);
            }
        }

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Iniciando Sistema Aut√≥nomo de Documentos...');
            window.auditSystem = new AutonomousAuditSystem();
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Aut√≥nomo de Documentos - Auditor√≠as Energ√©ticas</title>
    <script
