<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Auditor√≠as - 100% FUNCIONAL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .status-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: #2c5aa0;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .calculations {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .calc-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .calc-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 5px;
        }

        .calc-label {
            font-size: 0.9rem;
            color: #666;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .file-upload {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .calc-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üî• Sistema de Auditor√≠as Energ√©ticas</h1>
        <p>Generaci√≥n autom√°tica de documentos - VERSI√ìN FUNCIONAL</p>
        <div class="status-badge" id="systemStatus">‚è≥ Cargando librer√≠as...</div>
    </div>

    <div class="container">
        <div id="loadingScreen" class="loading">
            <div class="spinner"></div>
            <p>Cargando sistema y librer√≠as necesarias...</p>
            <p id="loadingStatus">Iniciando...</p>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="grid">
                <!-- Panel de Datos de Auditor√≠a -->
                <div class="card">
                    <h2>üìã Datos de Auditor√≠a</h2>
                    
                    <div class="form-group">
                        <label>Cliente</label>
                        <input type="text" id="clienteNombre" placeholder="Nombre de la empresa" value="Industrias Ejemplo S.A.">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Consumo (kWh)</label>
                            <input type="number" id="consumoKwh" placeholder="15420" value="15420">
                        </div>
                        <div class="form-group">
                            <label>Demanda (kW)</label>
                            <input type="number" id="demandaKw" placeholder="85" value="85">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Factor de Potencia</label>
                            <input type="number" id="factorPotencia" step="0.01" placeholder="0.85" value="0.85">
                        </div>
                        <div class="form-group">
                            <label>Tarifa</label>
                            <select id="tarifa">
                                <option value="GDMTO" selected>GDMTO</option>
                                <option value="GDMTH">GDMTH</option>
                                <option value="OM">OM</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üìé Archivos Adjuntos</label>
                        <div class="file-upload" id="fileUpload">
                            <p>üìÅ Elegir archivos o arrastrar aqu√≠</p>
                            <input type="file" id="fileInput" multiple style="display: none;">
                            <div id="fileList"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea id="observaciones" rows="3" placeholder="Observaciones adicionales">Sistema 100% funcional - Librer√≠as cargadas din√°micamente</textarea>
                    </div>
                </div>

                <!-- Panel de Generaci√≥n -->
                <div class="card">
                    <h2>üìÑ Generar Documento</h2>
                    
                    <div class="form-group">
                        <label>Tipo de Plantilla</label>
                        <select id="tipoPlantilla">
                            <option value="auditoria_basica">üìä Auditor√≠a B√°sica</option>
                            <option value="reporte_completo">üìà Reporte Completo</option>
                            <option value="resumen_ejecutivo">üëî Resumen Ejecutivo</option>
                            <option value="certificacion">üèÜ Certificaci√≥n</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Formato</label>
                        <select id="formato">
                            <option value="docx">üìò Word (.docx)</option>
                            <option value="html">üåê HTML</option>
                            <option value="rtf">üìù RTF</option>
                        </select>
                    </div>

                    <button class="btn btn-success" id="generarBtn" disabled>
                        üöÄ Generar Documento
                    </button>

                    <div id="status"></div>

                    <!-- C√°lculos Autom√°ticos -->
                    <div class="calculations">
                        <h3>üßÆ C√°lculos Autom√°ticos</h3>
                        <div class="calc-grid">
                            <div class="calc-item">
                                <div class="calc-value" id="costoMensual">$46,165.94</div>
                                <div class="calc-label">Costo Mensual</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-value" id="costoAnual">$553,991.28</div>
                                <div class="calc-label">Costo Anual</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-value" id="factorCarga">2.1%</div>
                                <div class="calc-label">Factor Carga</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-value" id="factorPotenciaMostrado">85.0%</div>
                                <div class="calc-label">Factor Potencia</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-value" id="ahorroLED">$12,006.82</div>
                                <div class="calc-label">Ahorro LED</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-value" id="recuperacion">10.6 a√±os</div>
                                <div class="calc-label">Recuperaci√≥n</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de Documentos -->
            <div class="card">
                <h2>üìö Historial de Documentos</h2>
                <div id="historial">
                    <p style="text-align: center; color: #666;">No hay documentos generados a√∫n</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== SISTEMA PRINCIPAL - CARGA DIN√ÅMICA DE LIBRER√çAS =====
        
        // Variables globales
        let documentosGenerados = 0;
        let sistemaInicializado = false;
        let archivosSeleccionados = [];
        let libreriasCargadas = false;

        // ===== CARGA DIN√ÅMICA DE LIBRER√çAS =====
        async function cargarLibrerias() {
            const loadingStatus = document.getElementById('loadingStatus');
            
            try {
                loadingStatus.textContent = 'Cargando PizZip...';
                
                // Cargar PizZip
                if (typeof PizZip === 'undefined') {
                    await cargarScript('https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js');
                }
                
                loadingStatus.textContent = 'Cargando Docxtemplater...';
                
                // Cargar Docxtemplater
                if (typeof Docxtemplater === 'undefined') {
                    await cargarScript('https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.0/docxtemplater.min.js');
                }
                
                loadingStatus.textContent = 'Verificando librer√≠as...';
                
                // Verificar que las librer√≠as est√°n disponibles
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (typeof PizZip === 'undefined') {
                    throw new Error('PizZip no se carg√≥ correctamente');
                }
                
                if (typeof Docxtemplater === 'undefined') {
                    console.warn('Docxtemplater no disponible, usando generaci√≥n b√°sica');
                }
                
                libreriasCargadas = true;
                loadingStatus.textContent = '‚úÖ Librer√≠as cargadas correctamente';
                
                return true;
                
            } catch (error) {
                console.error('Error cargando librer√≠as:', error);
                loadingStatus.textContent = '‚ö†Ô∏è Error cargando librer√≠as, usando modo b√°sico';
                libreriasCargadas = false;
                return false;
            }
        }

        function cargarScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log('‚úÖ Cargado:', src);
                    resolve();
                };
                script.onerror = () => {
                    console.error('‚ùå Error cargando:', src);
                    reject(new Error(`Error cargando ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // ===== INICIALIZACI√ìN DEL SISTEMA =====
        async function inicializarSistema() {
            console.log('üöÄ Inicializando Sistema de Auditor√≠as...');
            
            try {
                // Cargar librer√≠as primero
                const libreriasOK = await cargarLibrerias();
                
                // Inicializar sistema
                configurarEventListeners();
                actualizarCalculos();
                
                sistemaInicializado = true;
                
                // Mostrar interfaz principal
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                // Habilitar bot√≥n
                document.getElementById('generarBtn').disabled = false;
                document.getElementById('generarBtn').textContent = 'üöÄ Generar Documento';
                
                // Actualizar status
                const statusText = libreriasOK ? 
                    '‚úÖ Sistema completo operativo' : 
                    '‚ö†Ô∏è Sistema b√°sico operativo';
                    
                document.getElementById('systemStatus').textContent = statusText;
                document.getElementById('systemStatus').style.background = libreriasOK ? 
                    'linear-gradient(45deg, #28a745, #20c997)' : 
                    'linear-gradient(45deg, #ffc107, #fd7e14)';
                
                mostrarStatus('‚úÖ Sistema inicializado correctamente', 'success');
                console.log('‚úÖ Sistema listo para usar');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                mostrarStatus('‚ùå Error inicializando sistema: ' + error.message, 'error');
                document.getElementById('systemStatus').textContent = '‚ùå Error del sistema';
            }
        }

        function configurarEventListeners() {
            // Bot√≥n generar documento
            const generarBtn = document.getElementById('generarBtn');
            generarBtn.addEventListener('click', generarDocumento);

            // Actualizar c√°lculos cuando cambien los valores
            const campos = ['consumoKwh', 'demandaKw', 'factorPotencia', 'tarifa'];
            campos.forEach(id => {
                const elemento = document.getElementById(id);
                elemento.addEventListener('input', actualizarCalculos);
                elemento.addEventListener('change', actualizarCalculos);
            });

            // Manejo de archivos
            configurarManejoArchivos();
        }

        function configurarManejoArchivos() {
            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('fileInput');

            fileUpload.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                manejarArchivos(e.target.files);
            });

            // Drag & Drop
            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.style.borderColor = '#667eea';
            });

            fileUpload.addEventListener('dragleave', () => {
                fileUpload.style.borderColor = '#ccc';
            });

            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.style.borderColor = '#ccc';
                manejarArchivos(e.dataTransfer.files);
            });
        }

        function manejarArchivos(files) {
            const fileList = document.getElementById('fileList');
            const fileArray = Array.from(files);
            archivosSeleccionados = fileArray;
            
            if (fileArray.length > 0) {
                fileList.innerHTML = `
                    <div style="margin-top: 10px; font-size: 12px; color: #28a745;">
                        üìé ${fileArray.length} archivo(s) seleccionado(s):
                        ${fileArray.map(f => `<div>‚Ä¢ ${f.name}</div>`).join('')}
                    </div>
                `;
            } else {
                fileList.innerHTML = '';
            }
        }

        // ===== FUNCIONES DE C√ÅLCULO =====
        function actualizarCalculos() {
            const consumo = parseFloat(document.getElementById('consumoKwh').value) || 0;
            const demanda = parseFloat(document.getElementById('demandaKw').value) || 0;
            const fp = parseFloat(document.getElementById('factorPotencia').value) || 0;
            const tarifa = document.getElementById('tarifa').value;

            // C√°lculos energ√©ticos
            const costoKwh = obtenerTarifaCosto(tarifa);
            const costoMensual = (consumo * costoKwh + demanda * 189.92) / 12;
            const costoAnual = costoMensual * 12;
            const factorCarga = demanda > 0 ? (consumo / (demanda * 8760)) * 100 : 0;
            
            // C√°lculos de LED (simplificado)
            const ahorroLED = consumo * 0.4 * costoKwh; // 40% de ahorro t√≠pico
            const inversionLED = demanda * 1500; // Estimaci√≥n
            const recuperacion = ahorroLED > 0 ? inversionLED / ahorroLED : 0;

            // Actualizar UI
            document.getElementById('costoMensual').textContent = formatearMoneda(costoMensual);
            document.getElementById('costoAnual').textContent = formatearMoneda(costoAnual);
            document.getElementById('factorCarga').textContent = factorCarga.toFixed(1) + '%';
            document.getElementById('factorPotenciaMostrado').textContent = (fp * 100).toFixed(1) + '%';
            document.getElementById('ahorroLED').textContent = formatearMoneda(ahorroLED);
            document.getElementById('recuperacion').textContent = recuperacion.toFixed(1) + ' a√±os';
        }

        function obtenerTarifaCosto(tarifa) {
            const tarifas = {
                'GDMTO': 1.947,
                'GDMTH': 2.1,
                'OM': 0.956
            };
            return tarifas[tarifa] || 2.0;
        }

        function formatearMoneda(cantidad) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(cantidad);
        }

        // ===== FUNCI√ìN PRINCIPAL DE GENERACI√ìN =====
        async function generarDocumento() {
            if (!sistemaInicializado) {
                mostrarStatus('‚ö†Ô∏è Sistema no est√° listo', 'error');
                return;
            }

            const btn = document.getElementById('generarBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generando...';

            try {
                // Recopilar datos
                const datos = recopilarDatos();
                
                // Obtener plantilla
                const plantilla = obtenerPlantilla(datos.tipoPlantilla);
                
                // Procesar documento
                const contenido = procesarPlantilla(plantilla, datos);
                
                // Crear y descargar documento
                await crearDocumento(contenido, datos);
                
                // Agregar al historial
                agregarAlHistorial(datos);
                
                mostrarStatus(`‚úÖ Documento generado: ${datos.nombreArchivo}`, 'success');
                
            } catch (error) {
                console.error('Error generando documento:', error);
                mostrarStatus('‚ùå Error generando documento: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Generar Documento';
            }
        }

        function recopilarDatos() {
            const now = new Date();
            const consumo = parseFloat(document.getElementById('consumoKwh').value) || 0;
            const demanda = parseFloat(document.getElementById('demandaKw').value) || 0;
            const fp = parseFloat(document.getElementById('factorPotencia').value) || 0;
            const tarifa = document.getElementById('tarifa').value;
            const clienteNombre = document.getElementById('clienteNombre').value || 'Cliente Ejemplo';

            // Calcular datos
            const costoKwh = obtenerTarifaCosto(tarifa);
            const costoMensual = (consumo * costoKwh + demanda * 189.92) / 12;
            const costoAnual = costoMensual * 12;
            const factorCarga = demanda > 0 ? (consumo / (demanda * 8760)) * 100 : 0;
            const ahorroLED = consumo * 0.4 * costoKwh;

            return {
                // Datos b√°sicos
                clienteNombre: clienteNombre,
                consumoKwh: consumo,
                demandaKw: demanda,
                factorPotencia: fp,
                tarifa: tarifa,
                observaciones: document.getElementById('observaciones').value,
                tipoPlantilla: document.getElementById('tipoPlantilla').value,
                formato: document.getElementById('formato').value,
                
                // Datos calculados
                costoMensual: formatearMoneda(costoMensual),
                costoAnual: formatearMoneda(costoAnual),
                factorCarga: factorCarga.toFixed(1) + '%',
                ahorroLED: formatearMoneda(ahorroLED),
                
                // Metadatos
                fechaGeneracion: now.toLocaleDateString('es-ES'),
                horaGeneracion: now.toLocaleTimeString('es-ES'),
                numeroDocumento: `AUD-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(++documentosGenerados).padStart(3, '0')}`,
                nombreArchivo: `Auditoria_${clienteNombre.replace(/\s+/g, '_')}_${now.toISOString().split('T')[0]}`,
                
                // Archivos
                totalArchivos: archivosSeleccionados.length
            };
        }

        // ===== PLANTILLAS =====
        function obtenerPlantilla(tipo) {
            const plantillas = {
                auditoria_basica: `AUDITOR√çA ENERG√âTICA B√ÅSICA

INFORMACI√ìN DEL CLIENTE
Empresa: {{clienteNombre}}
Fecha: {{fechaGeneracion}}

DATOS ENERG√âTICOS
Consumo anual: {{consumoKwh}} kWh
Demanda: {{demandaKw}} kW
Factor de potencia: {{factorPotencia}}
Tarifa: {{tarifa}}

AN√ÅLISIS ECON√ìMICO
Costo mensual: {{costoMensual}}
Costo anual: {{costoAnual}}
Factor de carga: {{factorCarga}}

OPORTUNIDADES DE AHORRO
Ahorro LED estimado: {{ahorroLED}}

OBSERVACIONES
{{observaciones}}

ARCHIVOS ADJUNTOS
Total de archivos: {{totalArchivos}}

Documento: {{numeroDocumento}}
Generado: {{fechaGeneracion}} {{horaGeneracion}}`,

                reporte_completo: `REPORTE COMPLETO DE AUDITOR√çA ENERG√âTICA

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CLIENTE: {{clienteNombre}}
DOCUMENTO: {{numeroDocumento}}
FECHA: {{fechaGeneracion}}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

AN√ÅLISIS ENERG√âTICO DETALLADO

Consumo Total Anual: {{consumoKwh}} kWh
Demanda M√°xima: {{demandaKw}} kW
Factor de Potencia: {{factorPotencia}}
Factor de Carga: {{factorCarga}}
Tarifa Aplicada: {{tarifa}}

AN√ÅLISIS ECON√ìMICO

Costo Mensual Promedio: {{costoMensual}}
Costo Anual Total: {{costoAnual}}

OPORTUNIDADES DE MEJORA

Tecnolog√≠a LED:
- Ahorro estimado: {{ahorroLED}}
- Reducci√≥n en consumo: ~40%
- Periodo de recuperaci√≥n: 2-4 a√±os

RECOMENDACIONES

1. Implementar tecnolog√≠a LED en todas las √°reas
2. Corregir factor de potencia si es menor a 0.9
3. Implementar sistema de gesti√≥n energ√©tica
4. Capacitar al personal en uso eficiente de energ√≠a

OBSERVACIONES T√âCNICAS
{{observaciones}}

DOCUMENTACI√ìN ADJUNTA
Archivos incluidos: {{totalArchivos}}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Documento generado autom√°ticamente
Sistema de Auditor√≠as Energ√©ticas v1.0
{{fechaGeneracion}} {{horaGeneracion}}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`,

                resumen_ejecutivo: `RESUMEN EJECUTIVO
AUDITOR√çA ENERG√âTICA

Cliente: {{clienteNombre}}
Documento: {{numeroDocumento}}
Fecha: {{fechaGeneracion}}

DATOS CLAVE
‚Ä¢ Consumo anual: {{consumoKwh}} kWh
‚Ä¢ Costo anual: {{costoAnual}}
‚Ä¢ Factor de potencia: {{factorPotencia}}

OPORTUNIDAD PRINCIPAL
üí° Actualizaci√≥n a tecnolog√≠a LED
üí∞ Ahorro estimado: {{ahorroLED}}

RECOMENDACI√ìN
Implementar mejoras de eficiencia energ√©tica
con enfoque en iluminaci√≥n LED.

{{observaciones}}

Generado: {{fechaGeneracion}}`,

                certificacion: `CERTIFICADO DE AUDITOR√çA ENERG√âTICA

Se certifica que se ha realizado una auditor√≠a energ√©tica a:

{{clienteNombre}}

Consumo verificado: {{consumoKwh}} kWh/a√±o
Demanda registrada: {{demandaKw}} kW
Factor de potencia: {{factorPotencia}}

La instalaci√≥n cumple con los par√°metros evaluados.

Certificado v√°lido por 12 meses.

Documento: {{numeroDocumento}}
Fecha: {{fechaGeneracion}}

Auditor Energ√©tico Certificado`
            };

            return plantillas[tipo] || plantillas.auditoria_basica;
        }

        function procesarPlantilla(plantilla, datos) {
            let contenido = plantilla;
            
            // Reemplazar todas las variables
            Object.keys(datos).forEach(key => {
                const regex = new RegExp(`{{${key}}}`, 'g');
                contenido = contenido.replace(regex, datos[key]);
            });
            
            return contenido;
        }

        // ===== FUNCIONES DE CREACI√ìN DE DOCUMENTOS =====
        async function crearDocumento(contenido, datos) {
            const formato = datos.formato;
            const nombreArchivo = `${datos.nombreArchivo}.${formato}`;

            switch (formato) {
                case 'docx':
                    await crearDocx(contenido, nombreArchivo);
                    break;
                case 'html':
                    crearHtml(contenido, nombreArchivo);
                    break;
                case 'rtf':
                    crearRtf(contenido, nombreArchivo);
                    break;
                default:
                    throw new Error('Formato no soportado: ' + formato);
            }
        }

        async function crearDocx(contenido, nombreArchivo) {
            try {
                if (!libreriasCargadas || typeof PizZip === 'undefined') {
                    console.warn('PizZip no disponible, generando RTF compatible con Word');
                    await crearRtf(contenido, nombreArchivo.replace('.docx', '.rtf'));
                    mostrarStatus('üí° Documento generado en formato RTF (compatible con Word)', 'info');
                    return;
                }

                // Crear documento DOCX usando PizZip
                const zip = new PizZip();
                
                // Contenido del documento Word
                const docContent = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:body>
        ${contenido.split('\n').map(line => {
            const lineaTrim = line.trim();
            if (lineaTrim) {
                if (lineaTrim.includes('‚ïê‚ïê‚ïê') || (lineaTrim === lineaTrim.toUpperCase() && lineaTrim.length > 10)) {
                    return `<w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r><w:rPr><w:b/><w:sz w:val="28"/><w:color w:val="2c5aa0"/></w:rPr><w:t>${escapeXml(lineaTrim)}</w:t></w:r></w:p>`;
                } else {
                    return `<w:p><w:r><w:t>${escapeXml(lineaTrim)}</w:t></w:r></w:p>`;
                }
            }
            return '<w:p/>';
        }).join('')}
    </w:body>
</w:document>`;

                // Estructura b√°sica del archivo DOCX
                zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
    <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
    <Default Extension="xml" ContentType="application/xml"/>
    <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
    <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
    <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
    <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
</Types>`);

                zip.file('_rels/.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
    <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
    <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
</Relationships>`);

                zip.file('word/_rels/document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`);

                zip.file('word/document.xml', docContent);

                zip.file('word/styles.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:docDefaults>
        <w:rPrDefault>
            <w:rPr>
                <w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/>
                <w:sz w:val="22"/>
            </w:rPr>
        </w:rPrDefault>
    </w:docDefaults>
</w:styles>`);

                zip.file('docProps/core.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <dc:title>Auditor√≠a Energ√©tica</dc:title>
    <dc:creator>Sistema de Auditor√≠as</dc:creator>
    <dcterms:created xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:created>
    <dcterms:modified xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:modified>
</cp:coreProperties>`);

                zip.file('docProps/app.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties">
    <Application>Sistema de Auditor√≠as Energ√©ticas</Application>
    <DocSecurity>0</DocSecurity>
    <ScaleCrop>false</ScaleCrop>
    <LinksUpToDate>false</LinksUpToDate>
    <SharedDoc>false</SharedDoc>
    <HyperlinksChanged>false</HyperlinksChanged>
    <AppVersion>1.0</AppVersion>
</Properties>`);

                const content = zip.generate({ 
                    type: 'blob',
                    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                });
                
                descargarArchivo(content, nombreArchivo);

            } catch (error) {
                console.error('Error creando DOCX:', error);
                console.warn('Fallback a RTF...');
                await crearRtf(contenido, nombreArchivo.replace('.docx', '.rtf'));
                mostrarStatus('üí° Documento generado en formato RTF (compatible con Word)', 'info');
            }
        }

        function crearHtml(contenido, nombreArchivo) {
            const htmlContent = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor√≠a Energ√©tica - ${new Date().toLocaleDateString('es-ES')}</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            max-width: 21cm;
            margin: 0 auto;
            padding: 2cm;
            color: #333;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 3px solid #2c5aa0;
            padding-bottom: 20px;
        }
        
        .header h1 {
            color: #2c5aa0;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
        }
        
        .content {
            white-space: pre-wrap;
            font-family: inherit;
            line-height: 1.8;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        
        @media print {
            body { margin: 1cm; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö° AUDITOR√çA ENERG√âTICA</h1>
        <p>Sistema Automatizado de Generaci√≥n de Documentos</p>
        <div class="badge">üî• DOCUMENTO GENERADO AUTOM√ÅTICAMENTE</div>
    </div>
    
    <div class="content">${contenido}</div>
    
    <div class="footer">
        <p><strong>Sistema de Auditor√≠as Energ√©ticas v1.0</strong></p>
        <p>Generado: ${new Date().toLocaleString('es-ES')}</p>
        <p>üåê Documento HTML profesional</p>
    </div>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            descargarArchivo(blob, nombreArchivo);
        }

        function crearRtf(contenido, nombreArchivo) {
            // Generar RTF que es compatible con Word
            let rtf = '{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0 Calibri;}{\\f1 Arial;}}';
            rtf += '{\\colortbl;\\red44;\\green90;\\blue160;\\red40;\\green167;\\blue69;}'; // Colores
            
            // T√≠tulo principal
            rtf += '\\qc\\b\\fs36\\cf1 AUDITOR\\u205?A ENERG\\u201?TICA\\par\\par';
            rtf += '\\qc\\fs24\\cf2 Sistema Automatizado\\par\\par\\par';
            
            // Contenido
            const lineas = contenido.split('\n');
            lineas.forEach(linea => {
                const lineaTrim = linea.trim();
                if (!lineaTrim) {
                    rtf += '\\par';
                    return;
                }
                
                if (lineaTrim.includes('‚ïê‚ïê‚ïê') || (lineaTrim === lineaTrim.toUpperCase() && lineaTrim.length > 10)) {
                    // Encabezados
                    rtf += `\\qc\\b\\fs28\\cf1 ${lineaTrim}\\par\\par`;
                } else if (lineaTrim.includes(':')) {
                    // Campos con datos
                    const [label, value] = lineaTrim.split(':');
                    rtf += `\\b ${label.trim()}:\\b0  ${value ? value.trim() : ''}\\par`;
                } else {
                    // Texto normal
                    rtf += `${lineaTrim}\\par`;
                }
            });
            
            // Footer
            rtf += '\\par\\par\\qc\\fs16\\cf0 ';
            rtf += `Generado autom\\u225?ticamente \\u8226? ${new Date().toLocaleString('es-ES')}`;
            rtf += '}';

            const blob = new Blob([rtf], { type: 'application/rtf' });
            descargarArchivo(blob, nombreArchivo);
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function escapeXml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString().replace(/[<>&'"]/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                    default: return c;
                }
            });
        }

        function descargarArchivo(blob, nombreArchivo) {
            try {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = nombreArchivo;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL despu√©s de un tiempo
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
                
                console.log('‚úÖ Archivo descargado:', nombreArchivo);
                
            } catch (error) {
                console.error('Error descargando archivo:', error);
                throw new Error('Error al descargar el archivo: ' + error.message);
            }
        }

        function agregarAlHistorial(datos) {
            const historial = document.getElementById('historial');
            
            // Limpiar mensaje inicial
            if (historial.textContent.includes('No hay documentos')) {
                historial.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">
                        üìÑ ${datos.nombreArchivo}.${datos.formato}
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        Cliente: ${datos.clienteNombre} | 
                        Tipo: ${datos.tipoPlantilla.replace('_', ' ')} | 
                        ${datos.fechaGeneracion} ${datos.horaGeneracion}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="color: #28a745; font-weight: bold;">‚úÖ Generado</div>
                    <div style="font-size: 12px; color: #666;">#${documentosGenerados}</div>
                </div>
            `;

            historial.insertBefore(item, historial.firstChild);

            // Mantener solo los √∫ltimos 10
            while (historial.children.length > 10) {
                historial.removeChild(historial.lastChild);
            }
        }

        function mostrarStatus(message, type) {
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.className = `status status-${type}`;
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';

                // Auto-hide despu√©s de 5 segundos
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // ===== FUNCIONES PARA FLUTTERFLOW =====

        // Funci√≥n principal para FlutterFlow
        window.generarDocumentoFlutter = async function(datosFlutter) {
            if (!sistemaInicializado) {
                return {
                    success: false,
                    error: 'Sistema no inicializado'
                };
            }

            try {
                // Mapear datos de FlutterFlow al formulario
                if (datosFlutter.cliente) document.getElementById('clienteNombre').value = datosFlutter.cliente;
                if (datosFlutter.consumo) document.getElementById('consumoKwh').value = datosFlutter.consumo;
                if (datosFlutter.demanda) document.getElementById('demandaKw').value = datosFlutter.demanda;
                if (datosFlutter.factor_potencia) document.getElementById('factorPotencia').value = datosFlutter.factor_potencia;
                if (datosFlutter.tarifa) document.getElementById('tarifa').value = datosFlutter.tarifa;
                if (datosFlutter.observaciones) document.getElementById('observaciones').value = datosFlutter.observaciones;
                if (datosFlutter.tipo_plantilla) document.getElementById('tipoPlantilla').value = datosFlutter.tipo_plantilla;
                if (datosFlutter.formato) document.getElementById('formato').value = datosFlutter.formato;

                // Actualizar c√°lculos
                actualizarCalculos();

                // Generar documento
                await generarDocumento();
                
                return {
                    success: true,
                    mensaje: 'Documento generado correctamente desde FlutterFlow',
                    numero_documento: `AUD-${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(documentosGenerados).padStart(3, '0')}`,
                    sistema: {
                        librerias_cargadas: libreriasCargadas,
                        version: '1.0.0'
                    }
                };

            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        };

        // Funci√≥n para obtener c√°lculos
        window.obtenerCalculosFlutter = function(consumo, demanda, factorPotencia, tarifa) {
            if (!sistemaInicializado) {
                return { error: 'Sistema no inicializado' };
            }

            try {
                const costoKwh = obtenerTarifaCosto(tarifa);
                const costoMensual = (consumo * costoKwh + demanda * 189.92) / 12;
                const costoAnual = costoMensual * 12;
                const factorCarga = demanda > 0 ? (consumo / (demanda * 8760)) * 100 : 0;
                const ahorroLED = consumo * 0.4 * costoKwh;
                const inversionLED = demanda * 1500;
                const recuperacion = ahorroLED > 0 ? inversionLED / ahorroLED : 0;

                return {
                    success: true,
                    calculos: {
                        costo_mensual: costoMensual,
                        costo_mensual_formatted: formatearMoneda(costoMensual),
                        costo_anual: costoAnual,
                        costo_anual_formatted: formatearMoneda(costoAnual),
                        factor_carga: factorCarga,
                        factor_carga_formatted: factorCarga.toFixed(1) + '%',
                        ahorro_led: ahorroLED,
                        ahorro_led_formatted: formatearMoneda(ahorroLED),
                        periodo_recuperacion: recuperacion,
                        periodo_recuperacion_formatted: recuperacion.toFixed(1) + ' a√±os',
                        recomendacion: recuperacion < 3 ? 'RECOMENDADO' : 'CONSIDERAR'
                    }
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        };

        // Funci√≥n para configurar datos desde FlutterFlow
        window.configurarDatosFlutter = function(datos) {
            try {
                if (datos.cliente) document.getElementById('clienteNombre').value = datos.cliente;
                if (datos.consumo) document.getElementById('consumoKwh').value = datos.consumo;
                if (datos.demanda) document.getElementById('demandaKw').value = datos.demanda;
                if (datos.factor_potencia) document.getElementById('factorPotencia').value = datos.factor_potencia;
                if (datos.tarifa) document.getElementById('tarifa').value = datos.tarifa;
                if (datos.observaciones) document.getElementById('observaciones').value = datos.observaciones;
                
                // Actualizar c√°lculos
                actualizarCalculos();
                
                return { 
                    success: true, 
                    mensaje: 'Datos configurados correctamente',
                    datos_aplicados: datos
                };
            } catch (error) {
                return { 
                    success: false, 
                    error: error.message 
                };
            }
        };

        // Funci√≥n para obtener estado del sistema
        window.obtenerEstadoSistema = function() {
            return {
                inicializado: sistemaInicializado,
                librerias_cargadas: libreriasCargadas,
                documentos_generados: documentosGenerados,
                archivos_seleccionados: archivosSeleccionados.length,
                version: '1.0.0',
                librerias_disponibles: {
                    pizzip: typeof PizZip !== 'undefined',
                    docxtemplater: typeof Docxtemplater !== 'undefined'
                },
                funciones_disponibles: [
                    'generarDocumentoFlutter',
                    'obtenerCalculosFlutter', 
                    'configurarDatosFlutter',
                    'obtenerEstadoSistema'
                ]
            };
        };

        // ===== FUNCIONES DE DEBUGGING =====
        window.debugSistema = function() {
            const estado = obtenerEstadoSistema();
            console.log('üîç Estado del Sistema:', estado);
            console.table(estado.librerias_disponibles);
            return estado;
        };

        window.testGeneracion = async function() {
            console.log('üß™ Probando generaci√≥n de documento...');
            
            try {
                const resultado = await generarDocumentoFlutter({
                    cliente: 'Test Cliente',
                    consumo: 10000,
                    demanda: 50,
                    factor_potencia: 0.9,
                    tarifa: 'GDMTO',
                    tipo_plantilla: 'auditoria_basica',
                    formato: 'html'
                });
                
                console.log('‚úÖ Resultado del test:', resultado);
                return resultado;
                
            } catch (error) {
                console.error('‚ùå Error en test:', error);
                return { success: false, error: error.message };
            }
        };

        // ===== INICIALIZACI√ìN AUTOM√ÅTICA =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîÑ P√°gina cargada, iniciando sistema...');
            setTimeout(() => {
                inicializarSistema();
            }, 100);
        });

        // Manejo de errores globales
        window.addEventListener('error', function(e) {
            console.error('‚ùå Error global:', e.error);
            const statusElement = document.getElementById('loadingStatus');
            if (statusElement) {
                statusElement.textContent = '‚ö†Ô∏è Error: ' + e.error.message;
            }
        });

        // Mensaje de bienvenida
        console.log('üî• Sistema de Auditor√≠as Energ√©ticas v1.0');
        console.log('‚úÖ Versi√≥n con carga din√°mica de librer√≠as');
        console.log('üì± Listo para integraci√≥n con FlutterFlow');
        console.log('üß™ Ejecuta testGeneracion() para probar');
        console.log('üîç Ejecuta debugSistema() para estado completo');

    </script>
</body>
</html>
